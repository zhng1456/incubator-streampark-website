"use strict";(self.webpackChunkapache_streampark_website=self.webpackChunkapache_streampark_website||[]).push([[2478],{3905:(n,e,t)=>{t.d(e,{Zo:()=>u,kt:()=>d});var a=t(7294);function l(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function i(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(n);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,a)}return t}function r(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?i(Object(t),!0).forEach((function(e){l(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function c(n,e){if(null==n)return{};var t,a,l=function(n,e){if(null==n)return{};var t,a,l={},i=Object.keys(n);for(a=0;a<i.length;a++)t=i[a],e.indexOf(t)>=0||(l[t]=n[t]);return l}(n,e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);for(a=0;a<i.length;a++)t=i[a],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(l[t]=n[t])}return l}var o=a.createContext({}),p=function(n){var e=a.useContext(o),t=e;return n&&(t="function"==typeof n?n(e):r(r({},e),n)),t},u=function(n){var e=p(n.components);return a.createElement(o.Provider,{value:e},n.children)},s={inlineCode:"code",wrapper:function(n){var e=n.children;return a.createElement(a.Fragment,{},e)}},m=a.forwardRef((function(n,e){var t=n.components,l=n.mdxType,i=n.originalType,o=n.parentName,u=c(n,["components","mdxType","originalType","parentName"]),m=p(t),d=l,g=m["".concat(o,".").concat(d)]||m[d]||s[d]||i;return t?a.createElement(g,r(r({ref:e},u),{},{components:t})):a.createElement(g,r({ref:e},u))}));function d(n,e){var t=arguments,l=e&&e.mdxType;if("string"==typeof n||l){var i=t.length,r=new Array(i);r[0]=m;var c={};for(var o in e)hasOwnProperty.call(e,o)&&(c[o]=e[o]);c.originalType=n,c.mdxType="string"==typeof n?n:l,r[1]=c;for(var p=2;p<i;p++)r[p]=t[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},6063:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>o,contentTitle:()=>r,default:()=>s,frontMatter:()=>i,metadata:()=>c,toc:()=>p});var a=t(7462),l=(t(7294),t(3905));const i={id:"2-udf",title:"\u81ea\u5b9a\u4e49\u51fd\u6570",sidebar_position:2},r=void 0,c={unversionedId:"flinksql/udf/2-udf",id:"flinksql/udf/2-udf",title:"\u81ea\u5b9a\u4e49\u51fd\u6570",description:"\u7528\u6237\u81ea\u5b9a\u4e49\u51fd\u6570(udf)\u662f\u7528\u4e8e\u8c03\u7528\u7ecf\u5e38\u4f7f\u7528\u7684\u903b\u8f91\u6216\u5728\u67e5\u8be2\u4e2d\u65e0\u6cd5\u4ee5\u5176\u4ed6\u65b9\u5f0f\u5b9e\u73b0\u7684\u81ea\u5b9a\u4e49\u903b\u8f91\u7684\u6269\u5c55\u529f\u80fd\u3002",source:"@site/i18n/zh-CN/docusaurus-plugin-content-docs/current/flinksql/udf/2-udf.md",sourceDirName:"flinksql/udf",slug:"/flinksql/udf/2-udf",permalink:"/zh-CN/docs/flinksql/udf/2-udf",draft:!1,editUrl:"https://github.com/apache/incubator-streampark-website/edit/dev/i18n/zh-CN/docusaurus-plugin-content-docs/current/flinksql/udf/2-udf.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{id:"2-udf",title:"\u81ea\u5b9a\u4e49\u51fd\u6570",sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"\u7b80\u4ecb",permalink:"/zh-CN/docs/flinksql/udf/1-introduce"},next:{title:"\u7b80\u4ecb",permalink:"/zh-CN/docs/flinksql/format/1-introduce"}},o={},p=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"\u5b9e\u73b0\u6b65\u9aa4",id:"\u5b9e\u73b0\u6b65\u9aa4",level:2},{value:"\u51fd\u6570\u7c7b",id:"\u51fd\u6570\u7c7b",level:3},{value:"evaluation\u65b9\u6cd5",id:"evaluation\u65b9\u6cd5",level:3},{value:"\u7c7b\u578b\u63a8\u65ad",id:"\u7c7b\u578b\u63a8\u65ad",level:3},{value:"\u81ea\u5b9a\u4e49\u7c7b\u578b\u63a8\u65ad",id:"\u81ea\u5b9a\u4e49\u7c7b\u578b\u63a8\u65ad",level:3},{value:"\u786e\u5b9a\u6027\u7ed3\u679c",id:"\u786e\u5b9a\u6027\u7ed3\u679c",level:3},{value:"\u8fd0\u884c\u65f6\u96c6\u6210\u65b9\u6cd5",id:"\u8fd0\u884c\u65f6\u96c6\u6210\u65b9\u6cd5",level:3},{value:"\u6807\u91cf\u51fd\u6570",id:"\u6807\u91cf\u51fd\u6570",level:2},{value:"\u8868\u51fd\u6570",id:"\u8868\u51fd\u6570",level:2},{value:"\u805a\u5408\u51fd\u6570",id:"\u805a\u5408\u51fd\u6570",level:2},{value:"\u5fc5\u9009\u548c\u53ef\u9009\u65b9\u6cd5",id:"\u5fc5\u9009\u548c\u53ef\u9009\u65b9\u6cd5",level:3},{value:"\u8868\u805a\u5408\u51fd\u6570",id:"\u8868\u805a\u5408\u51fd\u6570",level:2},{value:"\u5fc5\u9009\u548c\u53ef\u9009\u65b9\u6cd5",id:"\u5fc5\u9009\u548c\u53ef\u9009\u65b9\u6cd5-1",level:3},{value:"Retraction\u6848\u4f8b",id:"retraction\u6848\u4f8b",level:3}],u={toc:p};function s(n){let{components:e,...i}=n;return(0,l.kt)("wrapper",(0,a.Z)({},u,i,{components:e,mdxType:"MDXLayout"}),(0,l.kt)("p",null,"\u7528\u6237\u81ea\u5b9a\u4e49\u51fd\u6570(udf)\u662f\u7528\u4e8e\u8c03\u7528\u7ecf\u5e38\u4f7f\u7528\u7684\u903b\u8f91\u6216\u5728\u67e5\u8be2\u4e2d\u65e0\u6cd5\u4ee5\u5176\u4ed6\u65b9\u5f0f\u5b9e\u73b0\u7684\u81ea\u5b9a\u4e49\u903b\u8f91\u7684\u6269\u5c55\u529f\u80fd\u3002"),(0,l.kt)("p",null,"\u7528\u6237\u81ea\u5b9a\u4e49\u51fd\u6570\u53ef\u4ee5\u7528JVM\u8bed\u8a00(\u5982Java\u6216Scala)\u6216Python\u5b9e\u73b0\u3002\u5b9e\u73b0\u8005\u53ef\u4ee5\u5728UDF\u4e2d\u4f7f\u7528\u4efb\u610f\u7684\u7b2c\u4e09\u65b9\u5e93\u3002\n\u672c\u7ae0\u5c06\u91cd\u70b9\u4ecb\u7ecd\u57fa\u4e8ejvm\u7684\u8bed\u8a00\uff0c\u8bf7\u53c2\u9605PyFlink\u6587\u6863\uff0c\u4e86\u89e3\u7528Python\u7f16\u5199\u901a\u7528udf\u7684\u8be6\u7ec6\u4fe1\u606f\u3002"),(0,l.kt)("h2",{id:"\u6982\u8ff0"},"\u6982\u8ff0"),(0,l.kt)("p",null,"\u76ee\u524d\uff0cFlink\u533a\u5206\u4e86\u4ee5\u4e0b\u51e0\u79cd\u51fd\u6570:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u6807\u91cf\u51fd\u6570\uff1a\u5c06\u6807\u91cf\u503c\u6620\u5c04\u5230\u4e00\u4e2a\u65b0\u7684\u6807\u91cf\u503c\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u8868\u51fd\u6570\uff1a\u5c06\u6807\u91cf\u503c\u6620\u5c04\u5230\u65b0\u884c\uff0c\u65b0\u884c\u6570\u636e\u53ef\u4ee5\u6709\u591a\u4e2a\u5b57\u6bb5\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u805a\u5408\u51fd\u6570\uff1a\u5c06\u591a\u884c\u6807\u91cf\u503c\u6620\u5c04\u4e3a\u65b0\u7684\u6807\u91cf\u503c\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u8868\u805a\u5408\u51fd\u6570\uff1a\u5c06\u591a\u884c\u6807\u91cf\u503c\u6620\u5c04\u5230\u65b0\u884c\uff0c\u65b0\u884c\u6570\u636e\u53ef\u4ee5\u6709\u591a\u4e2a\u5b57\u6bb5\u3002"),(0,l.kt)("li",{parentName:"ul"},"\u5f02\u6b65\u8868\u503c\u51fd\u6570\uff1a\u662f\u7528\u4e8e\u6267\u884c\u67e5\u627e\u8868\u6e90\u7684\u7279\u6b8a\u51fd\u6570\u3002")),(0,l.kt)("p",null,"\u4e0b\u9762\u7684\u793a\u4f8b\u5c55\u793a\u4e86\u5982\u4f55\u521b\u5efa\u4e00\u4e2a\u7b80\u5355\u7684\u6807\u91cf\u51fd\u6570\uff0c\u4ee5\u53ca\u5982\u4f55\u5728Table API\u548cSQL\u4e2d\u8c03\u7528\u8be5\u51fd\u6570\u3002"),(0,l.kt)("p",null,"\u5bf9\u4e8eSQL\u67e5\u8be2\uff0c\u51fd\u6570\u5fc5\u987b\u4f7f\u7528\u7279\u5b9a\u540d\u79f0\u6ce8\u518c\u4e4b\u540e\u624d\u80fd\u4f7f\u7528\u3002\u5bf9\u4e8eTable API\uff0c\u51fd\u6570\u53ef\u4ee5\u6ce8\u518c\u6216\u76f4\u63a5\u5185\u8054\u4f7f\u7528\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'import org.apache.flink.table.api.*;\nimport org.apache.flink.table.functions.ScalarFunction;\n\nimport static org.apache.flink.table.api.Expressions.*;\n\npublic class SubstringFunction extends ScalarFunction {\n    public String eval(String s, Integer begin, Integer end) {\n        return s.substring(begin, end);\n    }\n}\n\nclass UseFun {\n    public static void main(String[] args) {\n        EnvironmentSettings settings = EnvironmentSettings.newInstance().inStreamingMode().build();\n        TableEnvironment env = TableEnvironment.create(settings);\n        // \u5728table api\u4e2d\u4f7f\u7528\u4e0d\u6ce8\u518c\u7684\u5185\u8054\u65b9\u5f0f\u8c03\u7528\u51fd\u6570\n        env.from("MyTable").select(call(SubstringFunction.class, $("myField"), 5, 12));\n        // \u6ce8\u518c\u51fd\u6570\n        env.createTemporarySystemFunction("SubstringFunction", SubstringFunction.class);\n        // \u5728table api\u4e2d\u8c03\u7528\u6ce8\u518c\u8fc7\u7684\u51fd\u6570\n        env.from("MyTable").select(call("SubstringFunction", $("myField"), 5, 12));\n        // \u5728SQL\u4e2d\u8c03\u7528\u6ce8\u518c\u8fc7\u7684\u51fd\u6570\n        env.sqlQuery("SELECT SubstringFunction(myField, 5, 12) FROM MyTable");\n    }\n}\n')),(0,l.kt)("p",null,"\u5bf9\u4e8e\u4ea4\u4e92\u5f0f\u4f1a\u8bdd\uff0c\u4e5f\u53ef\u4ee5\u5728\u4f7f\u7528\u6216\u6ce8\u518c\u51fd\u6570\u4e4b\u524d\u5bf9\u5b83\u4eec\u8fdb\u884c\u53c2\u6570\u5316\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u5c06\u51fd\u6570\u5b9e\u4f8b\u800c\u4e0d\u662f\u51fd\u6570\u7c7b\u7528\u4f5c\u4e34\u65f6\u51fd\u6570\u3002"),(0,l.kt)("p",null,"\u5b83\u8981\u6c42\u53c2\u6570\u662f\u53ef\u5e8f\u5217\u5316\u7684\uff0c\u4ee5\u4fbf\u5c06\u51fd\u6570\u5b9e\u4f8b\u4f20\u9012\u5230\u96c6\u7fa4\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'import org.apache.flink.table.api.*;\nimport org.apache.flink.table.functions.ScalarFunction;\n\nimport static org.apache.flink.table.api.Expressions.*;\n\n// \u5b9a\u4e49\u53ef\u53c2\u6570\u5316\u51fd\u6570\u903b\u8f91\npublic class SubstringFunction extends ScalarFunction {\n    private boolean endInclusive;\n\n    public SubstringFunction(boolean endInclusive) {\n        this.endInclusive = endInclusive;\n    }\n\n    public String eval(String s, Integer begin, Integer end) {\n        return s.substring(begin, endInclusive ? end + 1 : end);\n    }\n}\n\nclass UseFun {\n    public static void main(String[] args) {\n        EnvironmentSettings settings = EnvironmentSettings.newInstance().inStreamingMode().build();\n        TableEnvironment env = TableEnvironment.create(settings);\n        //\u5728table api\u4e2d\u4f7f\u7528\u4e0d\u6ce8\u518c\u7684\u5185\u8054\u65b9\u5f0f\u8c03\u7528\u51fd\u6570\n        env.from("MyTable").select(call(new SubstringFunction(true), $("myField"), 5, 12));\n        //\u6ce8\u518c\u51fd\u6570\uff0c\u76f4\u63a5\u4f20\u9012\u521d\u59cb\u5316\u53c2\u6570\uff0c\u800c\u4e0d\u662f\u5728\u8c03\u7528\u65f6\u4f20\u9012\n        env.createTemporarySystemFunction("SubstringFunction", new SubstringFunction(true));\n    }\n}\n')),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"\u4ece1.14.x\u5f00\u59cb\u652f\u6301\u4ee5\u4e0b\u8bed\u6cd5\uff1a")),(0,l.kt)("p",null,"\u53ef\u4ee5\u4f7f\u7528\u661f\u53f7 ",(0,l.kt)("inlineCode",{parentName:"p"},"*")," \u4f5c\u4e3a\u51fd\u6570\u8c03\u7528\u7684\u53c2\u6570\uff0c\u5728Table API\u4e2d\u5145\u5f53\u901a\u914d\u7b26\uff0c\u8868\u793a\u8868\u4e2d\u7684\u6240\u6709\u5217\u90fd\u5c06\u88ab\u4f20\u9012\u7ed9\u51fd\u6570\u5bf9\u5e94\u7684\u4f4d\u7f6e\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'\nimport org.apache.flink.table.api.*;\nimport org.apache.flink.table.functions.ScalarFunction;\n\nimport static org.apache.flink.table.api.Expressions.*;\n\npublic static class MyConcatFunction extends ScalarFunction {\n    public String eval(@DataTypeHint(inputGroup = InputGroup.ANY) Object... fields) {\n        return Arrays.stream(fields)\n                .map(Object::toString)\n                .collect(Collectors.joining(","));\n    }\n}\n\nclass UseFun {\n    public static void main(String[] args) {\n        EnvironmentSettings settings = EnvironmentSettings.newInstance().inStreamingMode().build();\n        TableEnvironment env = TableEnvironment.create(settings);\n        // \u4f7f\u7528 $("*") \u6765\u8c03\u7528\u51fd\u6570\uff0c\u5982\u679c MyTable \u6709\u4e09\u4e2a\u5b57\u6bb5 (a, b, c), \u5219\u8fd9\u4e09\u4e2a\u6240\u6709\u7684\u5b57\u6bb5\u90fd\u5c06\u4f20\u9012\u7ed9 MyConcatFunction\u3002\n        env.from("MyTable").select(call(MyConcatFunction.class, $("*")));\n        // \u4e0a\u8ff0\u505a\u6cd5\u548c\u4e0b\u9762\u8fd9\u79cd\u663e\u5f0f\u7684\u6307\u5b9a\u6240\u6709\u7684\u5b57\u6bb5\u6709\u76f8\u540c\u7684\u6548\u679c\u3002\n        env.from("MyTable").select(call(MyConcatFunction.class, $("a"), $("b"), $("c")));\n    }\n}\n')),(0,l.kt)("h2",{id:"\u5b9e\u73b0\u6b65\u9aa4"},"\u5b9e\u73b0\u6b65\u9aa4"),(0,l.kt)("p",null,"\u4e0d\u7ba1\u662f\u5b9e\u73b0\u54ea\u79cd\u81ea\u5b9a\u4e49\u51fd\u6570\uff0c\u6240\u6709\u7528\u6237\u81ea\u5b9a\u4e49\u7684\u51fd\u6570\u90fd\u9075\u5faa\u4e00\u4e9b\u57fa\u672c\u7684\u5b9e\u73b0\u539f\u5219\u3002"),(0,l.kt)("h3",{id:"\u51fd\u6570\u7c7b"},"\u51fd\u6570\u7c7b"),(0,l.kt)("p",null,"\u5b9e\u73b0\u7c7b\u5fc5\u987b\u7ee7\u627f\u4e8e\u53ef\u7528\u7684\u57fa\u7c7b(\u4f8b\u5982",(0,l.kt)("inlineCode",{parentName:"p"},"org.apache.flink.table.functions.ScalarFunction"),")\u3002"),(0,l.kt)("p",null,"\u7c7b\u5fc5\u987b\u58f0\u660e\u4e3a\u516c\u6709\u7684\uff0c\u800c\u4e0d\u662f\u62bd\u8c61\u7684\uff0c\u5e76\u4e14\u662f\u5168\u5c40\u53ef\u8bbf\u95ee\u7684\u3002\u56e0\u6b64\uff0c\u4e0d\u5141\u8bb8\u4f7f\u7528\u975e\u9759\u6001\u7684\u5185\u90e8\u7c7b\u6216\u533f\u540d\u7c7b\u3002"),(0,l.kt)("p",null,"\u4e3a\u4e86\u5728\u6301\u4e45catalog\u4e2d\u5b58\u50a8\u7528\u6237\u81ea\u5b9a\u4e49\u51fd\u6570\uff0c\u7c7b\u5fc5\u987b\u5177\u6709\u9ed8\u8ba4\u6784\u9020\u51fd\u6570\uff0c\u5e76\u4e14\u5728\u8fd0\u884c\u65f6\u5fc5\u987b\u662f\u53ef\u5b9e\u4f8b\u5316\u7684\u3002"),(0,l.kt)("h3",{id:"evaluation\u65b9\u6cd5"},"evaluation\u65b9\u6cd5"),(0,l.kt)("p",null,"\u57fa\u7c7b\u63d0\u4f9b\u4e86\u4e00\u7ec4\u53ef\u4ee5\u88ab\u91cd\u5199\u7684\u65b9\u6cd5\uff0c\u5982",(0,l.kt)("strong",{parentName:"p"},"open()"),"\u3001",(0,l.kt)("strong",{parentName:"p"},"close()"),"\u6216",(0,l.kt)("strong",{parentName:"p"},"isDeterministic()"),"\u3002"),(0,l.kt)("p",null,"\u4f46\u662f\uff0c\u9664\u4e86\u90a3\u4e9b\u58f0\u660e\u7684\u65b9\u6cd5\u5916\uff0c\u5bf9\u4e8e\u6bcf\u6761\u4f20\u5165\u6570\u636e\u7684\u4e3b\u8981\u5904\u7406\u903b\u8f91\u5fc5\u987b\u901a\u8fc7\u4e13\u95e8\u7684\u65b9\u6cd5\u53bb\u5b9e\u73b0\u3002"),(0,l.kt)("p",null,"\u6839\u636e\u51fd\u6570\u7c7b\u578b\u7684\u4e0d\u540c\uff0c\u4ee3\u7801\u751f\u6210\u7684\u64cd\u4f5c\u7b26\u4f1a\u5728\u8fd0\u884c\u65f6\u8c03\u7528",(0,l.kt)("strong",{parentName:"p"},"eval()"),"\u3001",(0,l.kt)("strong",{parentName:"p"},"accumulate()"),"\u6216",(0,l.kt)("strong",{parentName:"p"},"retract()"),"\u7b49\u6c42\u503c\u65b9\u6cd5\u3002"),(0,l.kt)("p",null,"\u8fd9\u4e9b\u65b9\u6cd5\u5fc5\u987b\u58f0\u660e\u4e3a\u516c\u6709\uff0c\u5e76\u63a5\u53d7\u4e00\u7ec4\u5b9a\u4e49\u597d\u7684\u53c2\u6570\u3002"),(0,l.kt)("p",null,"\u5e38\u89c4JVM\u65b9\u6cd5\u5b9a\u4e49\u5728\u8fd9\u513f\u4e5f\u9002\u7528\u3002\u56e0\u6b64\u53ef\u4ee5\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5b9e\u73b0\u91cd\u8f7d\u65b9\u6cd5\uff0c\u5982",(0,l.kt)("inlineCode",{parentName:"li"},"eval(Integer)"),"\u548c",(0,l.kt)("inlineCode",{parentName:"li"},"eval(LocalDateTime)"),"\uff0c"),(0,l.kt)("li",{parentName:"ul"},"\u4f7f\u7528\u53ef\u53d8\u53c2\u6570\uff0c\u5982",(0,l.kt)("inlineCode",{parentName:"li"},"eval(Integer...)"),"\uff0c"),(0,l.kt)("li",{parentName:"ul"},"\u4f7f\u7528\u5bf9\u8c61\u7ee7\u627f\uff0c\u5982",(0,l.kt)("inlineCode",{parentName:"li"},"eval(object)"),"\uff0c\u540c\u65f6\u63a5\u53d7",(0,l.kt)("inlineCode",{parentName:"li"},"LocalDateTime"),"\u548c",(0,l.kt)("inlineCode",{parentName:"li"},"Integer"),"\uff0c"),(0,l.kt)("li",{parentName:"ul"},"\u53ef\u53d8\u53c2\u6570\u52a0\u5bf9\u8c61\u7ee7\u627f",(0,l.kt)("inlineCode",{parentName:"li"},"eval(Object...)"),"\uff0c\u63a5\u53d7\u5404\u79cd\u53c2\u6570\u3002")),(0,l.kt)("p",null,"\u5982\u679c\u60f3\u5728Scala\u4e2d\u5b9e\u73b0\u51fd\u6570\uff0c\u8bf7\u6dfb\u52a0",(0,l.kt)("inlineCode",{parentName:"p"},"Scala.annotation.varargs"),"\u6ce8\u91ca\u6765\u5904\u7406\u53d8\u91cf\u53c2\u6570\u3002\u6b64\u5916\uff0c\u5efa\u8bae\u4f7f\u7528\u5305\u88c5\u7c7b(\u4f8b\u5982",(0,l.kt)("strong",{parentName:"p"},"java.lang.Integer"),"\u800c\u4e0d\u662f",(0,l.kt)("inlineCode",{parentName:"p"},"Int"),")\u6765\u652f\u6301",(0,l.kt)("inlineCode",{parentName:"p"},"NULL"),"\u3002"),(0,l.kt)("p",null,"\u4e0b\u9762\u7684\u4ee3\u7801\u7247\u6bb5\u663e\u793a\u4e86\u91cd\u8f7d\u51fd\u6570\u7684\u793a\u4f8b\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"\nimport org.apache.flink.table.functions.ScalarFunction;\n\n//\u91cd\u8f7deval\u8fd9\u4e2a\u65b9\u6cd5\npublic class SumFunction extends ScalarFunction {\n    public Integer eval(Integer a, Integer b) {\n        return a + b;\n    }\n\n    public Integer eval(String a, String b) {\n        return Integer.parseInt(a) + Integer.parseInt(b);\n    }\n\n    public Integer eval(Double... d) {\n        double result = 0;\n        for (double value : d)\n            result += value;\n        return (int) result;\n    }\n\n}\n")),(0,l.kt)("h3",{id:"\u7c7b\u578b\u63a8\u65ad"},"\u7c7b\u578b\u63a8\u65ad"),(0,l.kt)("p",null,"\u8868\u751f\u6001\u7cfb\u7edf(\u7c7b\u4f3c\u4e8eSQL\u6807\u51c6)\u662f\u4e00\u4e2a\u5f3a\u7c7b\u578bAPI\u3002\u56e0\u6b64\uff0c\u51fd\u6570\u53c2\u6570\u548c\u8fd4\u56de\u7c7b\u578b\u90fd\u5fc5\u987b\u6620\u5c04\u5230\u4e4b\u524d\u7ae0\u8282\u4e2d\u63d0\u5230\u7684\u6570\u636e\u7c7b\u578b\u3002"),(0,l.kt)("p",null,"\u4ece\u903b\u8f91\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u5f00\u53d1\u4eba\u5458\u9700\u8981\u5173\u4e8e\u9884\u671f\u7c7b\u578b\u3001\u7cbe\u5ea6\u548c\u89c4\u6a21\u4fe1\u606f\u3002\u4eceJVM\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u89c4\u5212\u5668\u9700\u8981\u5173\u4e8e\u8c03\u7528\u7528\u6237\u5b9a\u4e49\u51fd\u6570\u65f6\u5982\u4f55\u5c06\u5185\u90e8\u6570\u636e\u7ed3\u6784\u8868\u793a\u4e3aJVM\u5bf9\u8c61\u7684\u4fe1\u606f\u3002"),(0,l.kt)("p",null,"\u9a8c\u8bc1\u8f93\u5165\u53c2\u6570\u4ee5\u53ca\u4e3a\u53c2\u6570\u548c\u51fd\u6570\u7ed3\u679c\u6d3e\u751f\u6570\u636e\u7c7b\u578b\u7684\u903b\u8f91\u5728\u7c7b\u578b\u63a8\u65ad\u4e2d\u5b9e\u73b0\u3002"),(0,l.kt)("p",null,"Flink\u7684\u7528\u6237\u81ea\u5b9a\u4e49\u51fd\u6570\u5b9e\u73b0\u4e86\u4e00\u4e2a\u81ea\u52a8\u7c7b\u578b\u63a8\u65ad\u63d0\u53d6\uff0c\u901a\u8fc7\u53cd\u5c04\u4ece\u51fd\u6570\u7684\u7c7b\u53ca\u5176\u4f30\u503c\u65b9\u6cd5\u6d3e\u751f\u6570\u636e\u7c7b\u578b\u3002\n\u5982\u679c\u8fd9\u79cd\u9690\u5f0f\u53cd\u5c04\u63d0\u53d6\u65b9\u6cd5\u6ca1\u6709\u6210\u529f\uff0c\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528",(0,l.kt)("inlineCode",{parentName:"p"},"@DataTypeHint"),"\u548c",(0,l.kt)("inlineCode",{parentName:"p"},"@FunctionHint"),"\u6ce8\u89e3\u6765\u6539\u53d8\u7684\u53c2\u6570\u3001\u7c7b\u6216\u65b9\u6cd5\u6765\u652f\u6301\u63d0\u53d6\u8fc7\u7a0b\u3002\u4e0b\u9762\u5c55\u793a\u4e86\u66f4\u591a\u5173\u4e8e\u5982\u4f55\u9002\u7528\u6ce8\u89e3\u7684\u793a\u4f8b\u3002\n\u5982\u679c\u9700\u8981\u66f4\u9ad8\u7ea7\u7684\u7c7b\u578b\u63a8\u65ad\u903b\u8f91\uff0c\u5b9e\u73b0\u8005\u53ef\u4ee5\u5728\u6bcf\u4e2a\u7528\u6237\u81ea\u5b9a\u4e49\u51fd\u6570\u4e2d\u663e\u5f0f\u8986\u76d6",(0,l.kt)("inlineCode",{parentName:"p"},"getTypeInference()"),"\u65b9\u6cd5\u3002\u63a8\u8350\u4f7f\u7528\u6ce8\u89e3\u65b9\u5f0f\uff0c\u56e0\u4e3a\u5b83\u4f1a\u5c06\u81ea\u5b9a\u4e49\u7c7b\u578b\u63a8\u65ad\u903b\u8f91\u4fdd\u6301\u5728\u53d7\u5f71\u54cd\u7684\u4f4d\u7f6e\u9644\u8fd1\uff0c\u7136\u540e\u56de\u9000\u5230\u9ed8\u8ba4\u884c\u4e3a\uff0c\u5e76\u4e0d\u4f1a\u5f71\u54cd\u5176\u4f59\u7684\u5b9e\u73b0\u3002"),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"\u81ea\u52a8\u7c7b\u578b\u63a8\u65ad")),(0,l.kt)("p",null,"\u81ea\u52a8\u7c7b\u578b\u63a8\u65ad\u4f1a\u68c0\u67e5\u51fd\u6570\u7684\u7c7b\u548c\u8ba1\u7b97\u65b9\u6cd5\uff0c\u4ee5\u6d3e\u751f\u51fd\u6570\u7684\u53c2\u6570\u548c\u7ed3\u679c\u7684\u6570\u636e\u7c7b\u578b\u3002",(0,l.kt)("inlineCode",{parentName:"p"},"@DataTypeHint"),"\u548c@",(0,l.kt)("inlineCode",{parentName:"p"},"FunctionHint"),"\u6ce8\u91ca\u652f\u6301\u81ea\u52a8\u63d0\u53d6\u3002"),(0,l.kt)("p",null,"\u6709\u5173\u53ef\u4ee5\u9690\u5f0f\u6620\u5c04\u5230\u6570\u636e\u7c7b\u578b\u7684\u5b8c\u6574\u7c7b\u5217\u8868\uff0c\u8bf7\u53c2\u9605",(0,l.kt)("a",{parentName:"p",href:"https://ci.apache.org/projects/flink/flink-docs-release-1.13/docs/dev/table/types/#data-type-extraction"},"\u6570\u636e\u7c7b\u578b\u63d0\u53d6\u90e8\u5206"),"\n\u3002"),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"@DataTypeHint")),(0,l.kt)("p",null,"\u5728\u8bb8\u591a\u573a\u666f\u4e2d\uff0c\u9700\u8981\u652f\u6301\u51fd\u6570\u7684\u53c2\u6570\u548c\u8fd4\u56de\u503c\u7c7b\u578b\u7684\u81ea\u52a8\u5185\u8054\u63d0\u53d6\u3002"),(0,l.kt)("p",null,"\u4e0b\u9762\u7684\u793a\u4f8b\u6f14\u793a\u5982\u4f55\u4f7f\u7528\u6570\u636e\u7c7b\u578b\u63d0\u793a\u3002\u66f4\u591a\u4fe1\u606f\u53ef\u4ee5\u5728\u6ce8\u89e3\u7c7b\u7684\u6587\u6863\u4e2d\u627e\u5230\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'\nimport org.apache.flink.table.annotation.DataTypeHint;\nimport org.apache.flink.table.annotation.InputGroup;\nimport org.apache.flink.table.functions.ScalarFunction;\nimport org.apache.flink.types.Row;\n\n//\u91cd\u8f7deval\u8fd9\u4e2a\u65b9\u6cd5\npublic class OverloadedFunction extends ScalarFunction {\n    // \u6ca1\u6709\u7c7b\u578b\u63d0\u793a\n    public Long eval(long a, long b) {\n        return a + b;\n    }\n\n    // \u6307\u5b9a\u5c0f\u6570\u7684\u957f\u5ea6\u548c\u7cbe\u5ea6\n    public @DataTypeHint("DECIMAL(12, 3)")\n    BigDecimal eval(double a, double b) {\n        return BigDecimal.valueOf(a + b);\n    }\n\n    // \u5b9a\u4e49\u4e00\u4e2a\u5d4c\u5957\u6570\u636e\u7c7b\u578b\n    @DataTypeHint("ROW<s STRING, t TIMESTAMP_LTZ(3)>")\n    public Row eval(int i) {\n        return Row.of(String.valueOf(i), Instant.ofEpochSecond(i));\n    }\n\n    // \u5141\u8bb8\u4efb\u4f55\u8f93\u5165\u548c\u81ea\u5b9a\u4e49\u7684\u5e8f\u5217\u5316\u8f93\u51fa\n    @DataTypeHint(value = "RAW", bridgedTo = ByteBuffer.class)\n    public ByteBuffer eval(@DataTypeHint(inputGroup = InputGroup.ANY) Object o) {\n        return MyUtils.serializeToByteBuffer(o);\n    }\n\n}\n')),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"@FunctionHint")),(0,l.kt)("p",null,"\u5728\u67d0\u4e9b\u573a\u666f\u4e2d\uff0c\u4e00\u4e2a\u6c42\u503c\u65b9\u6cd5\u53ef\u4ee5\u540c\u65f6\u5904\u7406\u591a\u4e2a\u4e0d\u540c\u7684\u6570\u636e\u7c7b\u578b\u3002\u800c\u4e14\uff0c\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u91cd\u8f7d\u7684\u6c42\u503c\u65b9\u6cd5\u6709\u4e00\u4e2a\u516c\u5171\u7684\u7ed3\u679c\u7c7b\u578b\uff0c\u5219\u5e94\u8be5\u53ea\u58f0\u660e\u4e00\u6b21\u3002"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"@FunctionHint"),"\u6ce8\u89e3\u53ef\u4ee5\u63d0\u4f9b\u4ece\u53c2\u6570\u6570\u636e\u7c7b\u578b\u5230\u7ed3\u679c\u6570\u636e\u7c7b\u578b\u7684\u6620\u5c04\u3002\u5b83\u652f\u6301\u4e3a\u8f93\u5165\u3001\u7d2f\u52a0\u5668\u548c\u7ed3\u679c\u6570\u636e\u7c7b\u578b\u6ce8\u89e3\u6574\u4e2a\u51fd\u6570\u7c7b\u6216\u6c42\u503c\u65b9\u6cd5\uff08\u76f8\u5f53\u4e8e\u8fd9\u4e9b\u7c7b\u578b\u7684\u516c\u5171\u6ce8\u89e3\uff09\u3002\n\u53ef\u4ee5\u5728\u7c7b\u4e0a\u58f0\u660e\u4e00\u4e2a\u6216\u591a\u4e2a\u6ce8\u89e3\uff0c\u4e5f\u53ef\u4ee5\u4e3a\u91cd\u8f7d\u51fd\u6570\u7b7e\u540d\u7684\u6bcf\u4e2a\u6c42\u503c\u65b9\u6cd5\u5355\u72ec\u58f0\u660e\u4e00\u4e2a\u6216\u591a\u4e2a\u6ce8\u89e3\u3002\u6240\u6709\u63d0\u793a\u53c2\u6570\u90fd\u662f\u53ef\u9009\u7684\u3002\u5982\u679c\u672a\u5b9a\u4e49\u53c2\u6570\uff0c\u5219\u4f7f\u7528\u9ed8\u8ba4\u7684\u57fa\u4e8e\u53cd\u5c04\u7684\u63d0\u53d6\u3002\u6240\u6709\u8ba1\u7b97\u65b9\u6cd5\u90fd\u7ee7\u627f\u4e8e\u5728\u51fd\u6570\u7c7b\u4e0a\u5b9a\u4e49\u7684\u63d0\u793a\u53c2\u6570\u3002"),(0,l.kt)("p",null,"\u4e0b\u9762\u7684\u793a\u4f8b\u6f14\u793a\u5982\u4f55\u4f7f\u7528\u51fd\u6570\u63d0\u793a\u3002\u66f4\u591a\u4fe1\u606f\u53ef\u4ee5\u5728\u6ce8\u89e3\u7c7b\u7684\u6587\u6863\u4e2d\u627e\u5230\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'\nimport org.apache.flink.table.annotation.DataTypeHint;\nimport org.apache.flink.table.annotation.FunctionHint;\nimport org.apache.flink.table.functions.TableFunction;\nimport org.apache.flink.types.Row;\n\n// \u91cd\u8f7deval\u65b9\u6cd5\uff0c\u4f7f\u7528\u5168\u5c40\u5b9a\u4e49\u7684\u8f93\u51fa\u7c7b\u578b\n@FunctionHint(output = @DataTypeHint("ROW<s STRING, i INT>"))\npublic class OverloadedFunction extends TableFunction<Row> {\n    public void eval(int a, int b) {\n        collect(Row.of("Sum", a + b));\n    }\n\n    public void eval() {\n        collect(Row.of("Empty args", -1));\n    }\n}\n\n// \u5c06\u7c7b\u578b\u63a8\u65ad\u548c\u6c42\u503c\u65b9\u6cd5\u89e3\u8026\uff0c\u5c06\u7c7b\u578b\u63a8\u65ad\u4ea4\u7ed9\u51fd\u6570\u63d0\u793a\n@FunctionHint(input = {@DataTypeHint("INT"), @DataTypeHint("INT")}, output = @DataTypeHint("INT"))\n@FunctionHint(input = {@DataTypeHint("BIGINT"), @DataTypeHint("BIGINT")}, output = @DataTypeHint("BIGINT"))\n@FunctionHint(input = {}, output = @DataTypeHint("BOOLEAN"))\n@FunctionHint(output = @DataTypeHint("ROW<s STRING, i INT>"))\npublic class OverloadedFunction extends TableFunction<Object> {\n    // \u5b9e\u73b0\u53ea\u9700\u8981\u786e\u5b9a\u65b9\u6cd5\u53ef\u4ee5\u88abJVM\u8c03\u7528\u5373\u53ef\n    public void eval(Object... o) {\n        if (o.length == 0) {\n            collect(false);\n        }\n        collect(o[0]);\n    }\n}\n')),(0,l.kt)("h3",{id:"\u81ea\u5b9a\u4e49\u7c7b\u578b\u63a8\u65ad"},"\u81ea\u5b9a\u4e49\u7c7b\u578b\u63a8\u65ad"),(0,l.kt)("p",null,"\u5bf9\u4e8e\u5927\u591a\u6570\u573a\u666f\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"@DataTypeHint"),"\u548c",(0,l.kt)("inlineCode",{parentName:"p"},"@FunctionHint"),"\u5e94\u8be5\u8db3\u4ee5\u6ee1\u8db3\u7528\u6237\u81ea\u5b9a\u4e49\u7684\u51fd\u6570\u5efa\u6a21\u3002\u7136\u800c\uff0c\u901a\u8fc7\u91cd\u5199",(0,l.kt)("inlineCode",{parentName:"p"},"getTypeInference()"),"\u4e2d\u5b9a\u4e49\u7684\u81ea\u52a8\u7c7b\u578b\u63a8\u65ad\uff0c\u5b9e\u73b0\u8005\u53ef\u4ee5\u521b\u5efa\u7c7b\u4f3c\u5185\u7f6e\u7cfb\u7edf\u51fd\u6570\u7684\u4efb\u610f\u51fd\u6570\u3002"),(0,l.kt)("p",null,"\u4e0b\u9762\u7528Java\u5b9e\u73b0\u7684\u793a\u4f8b\u8bf4\u660e\u81ea\u5b9a\u4e49\u7c7b\u578b\u63a8\u7406\u903b\u8f91\u7684\u6f5c\u529b\u3002\u5b83\u4f7f\u7528\u5b57\u7b26\u4e32\u5b57\u9762\u503c\u53c2\u6570\u6765\u786e\u5b9a\u51fd\u6570\u7684\u7ed3\u679c\u7c7b\u578b\u3002\u8be5\u51fd\u6570\u63a5\u6536\u4e24\u4e2a\u5b57\u7b26\u4e32\u53c2\u6570:\u7b2c\u4e00\u4e2a\u53c2\u6570\u8868\u793a\u8981\u89e3\u6790\u7684\u5b57\u7b26\u4e32\uff0c\u7b2c\u4e8c\u4e2a\u53c2\u6570\u8868\u793a\u76ee\u6807\u7c7b\u578b\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'\nimport org.apache.flink.table.api.DataTypes;\nimport org.apache.flink.table.catalog.DataTypeFactory;\nimport org.apache.flink.table.functions.ScalarFunction;\nimport org.apache.flink.table.types.inference.TypeInference;\nimport org.apache.flink.types.Row;\n\npublic class LiteralFunction extends ScalarFunction {\n    public Object eval(String s, String type) {\n        return switch (type) {\n            case "INT" -> Integer.valueOf(s);\n            case "DOUBLE" -> Double.valueOf(s);\n            case "STRING", default -> s;\n        };\n    }\n\n    // \u901a\u8fc7\u4e0b\u9762\u7684\u903b\u8f91\u4ee3\u66ff\u81ea\u52a8\u57fa\u4e8e\u53cd\u5c04\u7684\u7c7b\u578b\u63a8\u65ad\n    @Override\n    public TypeInference getTypeInference(DataTypeFactory typeFactory) {\n        return TypeInference.newBuilder()\n                // \u6307\u5b9a\u7c7b\u578b\u53c2\u6570\n                //\u5982\u679c\u9700\u8981\u7684haunt\uff0c\u53c2\u6570\u5c06\u4f1a\u88ab\u9690\u5f0f\u8f6c\u5316\u4e3a\u8fd9\u4e9b\u7c7b\u578b\n                .typedArguments(DataTypes.STRING(), DataTypes.STRING())\n                // \u6307\u5b9a\u51fd\u6570\u7684\u7ed3\u679c\u7c7b\u578b\u7b56\u7565\n                .outputTypeStrategy(callContext -> {\n                    if (!callContext.isArgumentLiteral(1) || callContext.isArgumentNull(1)) {\n                        throw callContext.newValidationError("Literal expected for second argument.");\n                    }\n                    // \u8fd4\u56de\u57fa\u4e8e\u5b57\u9762\u91cf\u7684\u6570\u636e\u7c7b\u578b\n                    final String literal = callContext.getArgumentValue(1, String.class).orElse("STRING");\n                    return switch (literal) {\n                        case "INT" -> Optional.of(DataTypes.INT().notNull());\n                        case "DOUBLE" -> Optional.of(DataTypes.DOUBLE().notNull());\n                        case "STRING", default -> Optional.of(DataTypes.STRING());\n                    };\n                })\n                .build();\n    }\n\n}\n')),(0,l.kt)("p",null,"\u6709\u5173\u81ea\u5b9a\u4e49\u7c7b\u578b\u63a8\u65ad\u7684\u66f4\u591a\u793a\u4f8b\uff0c\u8bf7\u53c2\u89c1\u5e26\u6709\n",(0,l.kt)("a",{parentName:"p",href:"https://github.com/apache/flink/blob/release-1.13/flink-examples/flink-examples-table/src/main/java/org/apache/flink/table/examples/java/functions/AdvancedFunctionsExample.java"},"\u9ad8\u7ea7\u51fd\u6570\u5b9e\u73b0"),"\n\u7684flink-examples-table\u6a21\u5757\u3002"),(0,l.kt)("h3",{id:"\u786e\u5b9a\u6027\u7ed3\u679c"},"\u786e\u5b9a\u6027\u7ed3\u679c"),(0,l.kt)("p",null,"\u6bcf\u4e2a\u7528\u6237\u81ea\u5b9a\u4e49\u7684\u51fd\u6570\u7c7b\u90fd\u53ef\u4ee5\u901a\u8fc7\u91cd\u5199",(0,l.kt)("inlineCode",{parentName:"p"},"isDeterministic()"),"\u65b9\u6cd5\u58f0\u660e\u5b83\u662f\u5426\u4ea7\u751f\u786e\u5b9a\u6027\u7ed3\u679c\u3002\u5982\u679c\u51fd\u6570\u4e0d\u662f\u7eaf\u51fd\u6570(\u5982",(0,l.kt)("inlineCode",{parentName:"p"},"random()"),"\u3001",(0,l.kt)("inlineCode",{parentName:"p"},"date()"),"\u6216",(0,l.kt)("inlineCode",{parentName:"p"},"now()"),")\uff0c\u5219\u8be5\u65b9\u6cd5\u5fc5\u987b\u8fd4\u56defalse\u3002\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"isDeterministic()"),"\u8fd4\u56detrue\u3002"),(0,l.kt)("p",null,"\u786e\u5b9a\u6027\u7ed3\u679c\u89e3\u91ca\uff1a\u50cf",(0,l.kt)("inlineCode",{parentName:"p"},"random()"),"\u7b49\u51fd\u6570\uff0c\u7531\u4e8e\u5728SQL\u4e2d\u8c03\u7528\u51fd\u6570\u65f6\uff0c\u6bcf\u884c\u6570\u636e\u90fd\u4f1a\u8c03\u7528\u4e00\u6b21\u51fd\u6570\uff0c\u5982\u679c",(0,l.kt)("inlineCode",{parentName:"p"},"isDeterministic()"),"\u65b9\u6cd5\u8fd4\u56defalse\uff0c\u5219\u6bcf\u6b21\u8c03\u7528\u8fd9\u7c7b\u51fd\u6570\uff0c\u90fd\u4f1a\u4ea7\u751f\u4e00\u4e2a\u65b0\u7684\u7ed3\u679c\uff0c\n\u4e5f\u5c31\u662f\u8bf4\uff0c\u51fd\u6570\u5185\u90e8\u903b\u8f91\u5fc5\u8d70\u4e00\u6b21\uff1b\u5982\u679c",(0,l.kt)("inlineCode",{parentName:"p"},"isDeterministic()"),"\u65b9\u6cd5\u8fd4\u56de",(0,l.kt)("inlineCode",{parentName:"p"},"true"),"\uff0c\u8be5\u51fd\u6570\u5219\u4f1a\u9884\u5148\u6267\u884c\u4e00\u6b21\uff0c\u7136\u540e\u96c6\u7fa4\u8fd0\u884cSQL\u65f6\u4f1a\u76f4\u63a5\u4f7f\u7528\u9884\u5148\u6267\u884c\u540e\u7684\u7ed3\u679c\uff0c\u800c\u4e0d\u662f\u6bcf\u884c\u6570\u636e\u90fd\u8c03\u7528\u4e00\u6b21\u8fd9\u4e2a\u51fd\u6570\u3002\n\u5982\u679c\u51fd\u6570\u5c06\u6570\u636e\u5217\u4f5c\u4e3a\u53c2\u6570\uff0c\u6bcf\u884c\u6570\u636e\u90fd\u4f1a\u6267\u884c\u4e00\u6b21\u51fd\u6570\uff0c\u56e0\u4e3a\u6570\u636e\u5217\u7684\u503c\u5bf9\u51fd\u6570\u6765\u8bf4\u662f\u4e0d\u786e\u5b9a\u7684\u3002\u4e0a\u8ff0\u8ba8\u8bba\u7684\u662f\u65e0\u6570\u636e\u884c\u5217\u53c2\u6570\u7684\u51fd\u6570\u3002"),(0,l.kt)("p",null,"\u6b64\u5916\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"isDeterministic()"),"\u65b9\u6cd5\u8fd8\u53ef\u80fd\u5f71\u54cd\u8fd0\u884c\u65f6\u884c\u4e3a\u3002\u51fd\u6570\u53ef\u80fd\u4f1a\u5728\u4e24\u4e2a\u4e0d\u540c\u7684\u9636\u6bb5\u88ab\u8c03\u7528\uff1a"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"\u5728\u89c4\u5212\u671f\u95f4(\u5373\u9884\u8fd0\u884c\u9636\u6bb5)\uff1a\u5982\u679c\u4e00\u4e2a\u51fd\u6570\u901a\u8fc7\u5e38\u91cf\u8868\u8fbe\u5f0f\u8c03\u7528\uff0c\u6216\u8005\u53ef\u4ee5\u4ece\u7ed9\u5b9a\u7684\u8bed\u53e5\u6d3e\u751f\u51fa\u5e38\u91cf\u8868\u8fbe\u5f0f\uff0c\u5219\u8be5\u51fd\u6570\u5c06\u88ab\u9884\u5148\u6267\u884c\u6c42\u51fa\u7ed3\u679c\u503c\u4ee5\u51cf\u5c11\u5e38\u91cf\u8868\u8fbe\u5f0f\u7684\u8fd0\u884c\u6b21\u6570\uff0c\u5e76\u4e14\u53ef\u80fd\u4e0d\u518d\u5728\u96c6\u7fa4\u4e0a\u6267\u884c\u8be5\u51fd\u6570\u3002\n\u9664\u975e\u4f7f\u7528",(0,l.kt)("inlineCode",{parentName:"li"},"isDeterministic()"),"\u6765\u7981\u7528\u5e38\u91cf\u8868\u8fbe\u5f0f\u7684\u8fd9\u79cd\u7f29\u51cf\u7279\u6027\u3002\n\u4f8b\u5982\uff0c\u5728\u89c4\u5212\u65f6\u5bf9ABS\u7684\u8c03\u7528\u5982\u4e0b\uff1a",(0,l.kt)("inlineCode",{parentName:"li"},"SELECT ABS(-1) FROM t")," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},"SELECT ABS(field) FROM t WHERE field = -1"),";\u800c",(0,l.kt)("inlineCode",{parentName:"li"},"SELECT ABS(field) FROM t"),"\n\u5219\u4e0d\u662f\u5e38\u91cf\u8868\u8fbe\u5f0f\u3002"),(0,l.kt)("li",{parentName:"ol"},"\u5728\u8fd0\u884c\u65f6(\u5373\u96c6\u7fa4\u6267\u884c)\uff1a\u5982\u679c\u4e00\u4e2a\u51fd\u6570\u88ab\u975e\u5e38\u91cf\u8868\u8fbe\u5f0f\u8c03\u7528\u6216",(0,l.kt)("inlineCode",{parentName:"li"},"isDeterministic()"),"\u8fd4\u56de",(0,l.kt)("inlineCode",{parentName:"li"},"false"),"\u3002")),(0,l.kt)("h3",{id:"\u8fd0\u884c\u65f6\u96c6\u6210\u65b9\u6cd5"},"\u8fd0\u884c\u65f6\u96c6\u6210\u65b9\u6cd5"),(0,l.kt)("p",null,"\u6709\u65f6\u5019\uff0c\u7528\u6237\u81ea\u5b9a\u4e49\u7684\u51fd\u6570\u53ef\u80fd\u9700\u8981\u5728\u5b9e\u9645\u5de5\u4f5c\u4e4b\u524d\u83b7\u53d6\u5168\u5c40\u8fd0\u884c\u65f6\u4fe1\u606f\u6216\u505a\u4e00\u4e9b\u8bbe\u7f6e/\u6e05\u7406\u5de5\u4f5c\u3002"),(0,l.kt)("p",null,"\u7528\u6237\u81ea\u5b9a\u4e49\u51fd\u6570\u63d0\u4f9b\u4e86\u53ef\u4ee5\u88ab\u91cd\u5199\u7684",(0,l.kt)("strong",{parentName:"p"},"open()"),"\u548c",(0,l.kt)("strong",{parentName:"p"},"close()"),"\u65b9\u6cd5\uff0c\u5e76\u63d0\u4f9b\u4e86\u4e0eDataStream API\u7684RichFunction\u4e2d\u7684\u65b9\u6cd5\u7c7b\u4f3c\u7684\u65b9\u6cd5\u3002"),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"open()"),"\u65b9\u6cd5\u5728\u6c42\u503c\u65b9\u6cd5\u4e4b\u524d\u8c03\u7528\u4e00\u6b21\uff0c\u6700\u540e\u4e00\u6b21\u8c03\u7528\u6c42\u503c\u65b9\u6cd5\u4e4b\u540e\u8c03\u7528",(0,l.kt)("strong",{parentName:"p"},"close()"),"\u65b9\u6cd5\u3002"),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"open()"),"\u65b9\u6cd5\u63d0\u4f9b\u4e86\u4e00\u4e2a",(0,l.kt)("inlineCode",{parentName:"p"},"FunctionContext"),"\uff0c\u5b83\u5305\u542b\u4e86\u6709\u5173\u7528\u6237\u5b9a\u4e49\u51fd\u6570\u6267\u884c\u7684\u4e0a\u4e0b\u6587\u7684\u4fe1\u606f\uff0c\u4f8b\u5982\u5ea6\u91cf\u7ec4\uff08MetricGroup\uff09\u6570\u636e\u3001\u5206\u5e03\u5f0f\u7f13\u5b58\u6587\u4ef6\u6216\u5168\u5c40\u4f5c\u4e1a\u53c2\u6570\u3002"),(0,l.kt)("p",null,"\u901a\u8fc7\u8c03\u7528FunctionContext\u7684\u76f8\u5e94\u65b9\u6cd5\u53ef\u4ee5\u83b7\u5f97\u4ee5\u4e0b\u4fe1\u606f\uff1a"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:"left"},"\u65b9\u6cd5"),(0,l.kt)("th",{parentName:"tr",align:"left"},"\u63cf\u8ff0"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:"left"},"getMetricGroup()"),(0,l.kt)("td",{parentName:"tr",align:"left"},"\u5b50\u4efb\u52a1\u7684\u5ea6\u91cf\u7ec4\u4fe1\u606f")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:"left"},"getCachedFile(name)"),(0,l.kt)("td",{parentName:"tr",align:"left"},"\u672c\u5730\u4e34\u65f6\u6587\u4ef6\u62f7\u8d1d\u5230\u5206\u5e03\u5f0f\u7684\u7f13\u5b58\u6587\u4ef6")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:"left"},"getJobParameter(name, defaultValue)"),(0,l.kt)("td",{parentName:"tr",align:"left"},"\u5bf9\u5e94key\u7684\u5168\u5c40\u4f5c\u4e1a\u53c2\u6570\u503c")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:"left"},"getExternalResourceInfos(resourceName)"),(0,l.kt)("td",{parentName:"tr",align:"left"},"\u8fd4\u56de\u5bf9\u5e94key\u7684\u5916\u90e8\u8d44\u6e90\u4fe1\u606f\u96c6\u5408")))),(0,l.kt)("p",null,"\u53d6\u51b3\u4e8e\u51fd\u6570\u6267\u884c\u7684\u4e0a\u4e0b\u6587\uff0c\u5e76\u975e\u6240\u6709\u4e0a\u8ff0\u65b9\u6cd5\u90fd\u53ef\u7528\u3002\u4f8b\u5982\uff0c\u5728\u51cf\u5c11\u5e38\u91cf\u8868\u8fbe\u5f0f\u671f\u95f4\uff0c\u6dfb\u52a0\u6307\u6807\u662f\u4e00\u4e2a\u65e0\u9700\u6267\u884c\u7684\u64cd\u4f5c\u3002"),(0,l.kt)("p",null,"\u4e0b\u9762\u7684\u793a\u4f8b\u7247\u6bb5\u5c55\u793a\u4e86\u5982\u4f55\u5728\u6807\u91cf\u51fd\u6570\u4e2d\u4f7f\u7528",(0,l.kt)("inlineCode",{parentName:"p"},"FunctionContext"),"\u6765\u8bbf\u95ee\u5168\u5c40\u4f5c\u4e1a\u53c2\u6570\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'import org.apache.flink.table.api.*;\nimport org.apache.flink.table.functions.FunctionContext;\nimport org.apache.flink.table.functions.ScalarFunction;\n\npublic class HashCodeFunction extends ScalarFunction {\n    private int factor = 0;\n\n    @Override\n    public void open(FunctionContext context) {\n        // \u8bbf\u95ee\u5168\u5c40\u53c2\u6570\u201chashcode_factor\u201d\u7684\u503c\uff0c\u5982\u679c\u53c2\u6570\u4e0d\u5b58\u5728\uff0c\u5219\u201c12\u201d\u4e3a\u5176\u9ed8\u8ba4\u503c\n        factor = Integer.parseInt(context.getJobParameter("hashcode_factor", "12"));\n    }\n\n    public int eval(String s) {\n        return s.hashCode() * factor;\n    }\n}\n\nclass UseFun {\n    public static void main(String[] args) {\n        EnvironmentSettings settings = EnvironmentSettings.newInstance().inStreamingMode().build();\n        TableEnvironment env = TableEnvironment.create(settings);\n        // \u6dfb\u52a0\u4f5c\u4e1a\u53c2\u6570\n        env.getConfig().addJobParameter("hashcode_factor", "31");\n        // \u6ce8\u518c\u51fd\u6570\n        env.createTemporarySystemFunction("hashCode", HashCodeFunction.class);\n        // \u8c03\u7528\u81ea\u5b9a\u4e49\u51fd\u6570\n        env.sqlQuery("SELECT myField, hashCode(myField) FROM MyTable");\n    }\n}\n\n')),(0,l.kt)("h2",{id:"\u6807\u91cf\u51fd\u6570"},"\u6807\u91cf\u51fd\u6570"),(0,l.kt)("p",null,"\u7528\u6237\u81ea\u5b9a\u4e49\u7684\u6807\u91cf\u51fd\u6570\u4f1a\u5c06\u96f6\u3001\u4e00\u4e2a\u6216\u591a\u4e2a\u6807\u91cf\u503c\u6620\u5c04\u5230\u4e00\u4e2a\u65b0\u7684\u6807\u91cf\u503c\u3002\n",(0,l.kt)("a",{parentName:"p",href:"https://ci.apache.org/projects/flink/flink-docs-release-1.13/docs/dev/table/types/"},"\u6570\u636e\u7c7b\u578b"),"\n\u90e8\u5206\u4e2d\u5217\u51fa\u7684\u4efb\u4f55\u6570\u636e\u7c7b\u578b\u90fd\u53ef\u4ee5\u7528\u4f5c\u6c42\u503c\u65b9\u6cd5\u7684\u53c2\u6570\u6216\u8fd4\u56de\u7c7b\u578b\u3002"),(0,l.kt)("p",null,"\u4e3a\u4e86\u81ea\u5b9a\u4e49\u4e00\u4e2a\u6807\u91cf\u51fd\u6570\uff0c\u5fc5\u987b\u6269\u5c55",(0,l.kt)("inlineCode",{parentName:"p"},"org.apache. fleck .table.functions"),"\u4e2d\u7684\u57fa\u7c7b",(0,l.kt)("inlineCode",{parentName:"p"},"ScalarFunction"),"\uff0c\u5e76\u5b9e\u73b0\u4e00\u4e2a\u6216\u591a\u4e2a\u540d\u4e3a",(0,l.kt)("inlineCode",{parentName:"p"},"eval(...)"),"\u7684\u6c42\u503c\u65b9\u6cd5\u3002"),(0,l.kt)("p",null,"\u4e0b\u9762\u7684\u793a\u4f8b\u6f14\u793a\u5982\u4f55\u5b9a\u4e49\u81ea\u5df1\u7684\u54c8\u5e0c\u7801\u51fd\u6570\u5e76\u5728\u67e5\u8be2\u4e2d\u8c03\u7528\u5b83\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'import org.apache.flink.table.annotation.InputGroup;\nimport org.apache.flink.table.api.*;\nimport org.apache.flink.table.functions.ScalarFunction;\n\nimport static org.apache.flink.table.api.Expressions.*;\n\npublic class HashFunction extends ScalarFunction {\n    // \u5141\u8bb8\u8f93\u5165\u4efb\u4f55\u7c7b\u578b\u6570\u636e\uff0c\u7136\u540e\u8fd4\u56deINT\u7c7b\u578b\n    public int eval(@DataTypeHint(inputGroup = InputGroup.ANY) Object o) {\n        return o.hashCode();\n    }\n}\n\nclass UseFun {\n    public static void main(String[] args) {\n        EnvironmentSettings settings = EnvironmentSettings.newInstance().inStreamingMode().build();\n        TableEnvironment env = TableEnvironment.create(settings);\n        // \u5728Table API\u4e2d\u901a\u8fc7\u5185\u8054\u65b9\u5f0f\u8c03\u7528\u672a\u6ce8\u518c\u7684\u51fd\u6570\n        env.from("MyTable").select(call(HashFunction.class, $("myField")));\n        // \u6ce8\u518c\u51fd\u6570\n        env.createTemporarySystemFunction("HashFunction", HashFunction.class);\n        // \u5728Table API\u4e2d\u8c03\u7528\u6ce8\u518c\u7684\u51fd\u6570\n        env.from("MyTable").select(call("HashFunction", $("myField")));\n        // \u5728SQL\u4e2d\u8c03\u7528\u6ce8\u518c\u7684\u51fd\u6570\n        env.sqlQuery("SELECT HashFunction(myField) FROM MyTable");\n    }\n}\n')),(0,l.kt)("h2",{id:"\u8868\u51fd\u6570"},"\u8868\u51fd\u6570"),(0,l.kt)("p",null,"\u4e0e\u7528\u6237\u81ea\u5b9a\u4e49\u7684\u6807\u91cf\u51fd\u6570\u7c7b\u4f3c\uff0c\u7528\u6237\u81ea\u5b9a\u4e49\u7684\u8868\u51fd\u6570(UDTF)\u63a5\u53d7\u96f6\u4e2a\u3001\u4e00\u4e2a\u6216\u591a\u4e2a\u6807\u91cf\u503c\u4f5c\u4e3a\u8f93\u5165\u53c2\u6570\u3002\u4f46\u662f\uff0c\u5b83\u53ef\u4ee5\u8fd4\u56de\u4efb\u610f\u6570\u91cf\u7684\u884c(\u6216\u7ed3\u6784\u5316\u7c7b\u578b)\u4f5c\u4e3a\u8f93\u51fa\uff0c\u800c\u4e0d\u662f\u5355\u4e2a\u503c\u3002\n\u8fd4\u56de\u7684\u8bb0\u5f55\u53ef\u4ee5\u7531\u4e00\u4e2a\u6216\u591a\u4e2a\u5b57\u6bb5\u7ec4\u6210\u3002\u5982\u679c\u8f93\u51fa\u8bb0\u5f55\u53ea\u5305\u542b\u4e00\u4e2a\u5b57\u6bb5\uff0c\u5219\u53ef\u4ee5\u7701\u7565\u7ed3\u6784\u5316\u6570\u636e\uff0c\u5e76\u4e14\u53ef\u4ee5\u53d1\u51fa\u4e00\u4e2a\u6807\u91cf\u503c\uff0c\u8be5\u6807\u91cf\u503c\u5c06\u7531\u8fd0\u884c\u65f6\u9690\u5f0f\u5305\u88c5\u5230row\u4e2d\u3002"),(0,l.kt)("p",null,"\u4e3a\u4e86\u5b9a\u4e49\u8868\u51fd\u6570\uff0c\u5fc5\u987b\u6269\u5c55",(0,l.kt)("inlineCode",{parentName:"p"},"org.apache.flink.table.functions"),"\u4e2d\u7684\u57fa\u7c7b",(0,l.kt)("inlineCode",{parentName:"p"},"TableFunction"),"\uff0c\u5e76\u5b9e\u73b0\u4e00\u4e2a\u6216\u591a\u4e2a\u540d\u4e3a",(0,l.kt)("inlineCode",{parentName:"p"},"eval(...)"),"\u7684\u6c42\u503c\u65b9\u6cd5\u3002"),(0,l.kt)("p",null,"\u4e0e\u5176\u4ed6\u51fd\u6570\u7c7b\u4f3c\uff0c\u4f7f\u7528\u53cd\u5c04\u81ea\u52a8\u63d0\u53d6\u8f93\u5165\u548c\u8f93\u51fa\u6570\u636e\u7c7b\u578b\uff0c\u5305\u62ec\u7528\u4e8e\u786e\u5b9a\u8f93\u51fa\u6570\u636e\u7c7b\u578b\u7684\u6cdb\u578b\u53c2\u6570T\u3002\u4e0e\u6807\u91cf\u51fd\u6570\u4e0d\u540c\uff0c\u6c42\u503c\u65b9\u6cd5\u672c\u8eab\u4e0d\u80fd\u6709\u8fd4\u56de\u7c7b\u578b\uff0c\n\u76f8\u53cd\uff0c\u8868\u51fd\u6570\u63d0\u4f9b\u4e86\u4e00\u4e2a",(0,l.kt)("inlineCode",{parentName:"p"},"collect(T)"),"\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5728\u6bcf\u4e2a\u6c42\u503c\u65b9\u6cd5\u4e2d\u8c03\u7528\u8be5\u65b9\u6cd5\uff0c\u4ee5\u53d1\u51fa\u96f6\u6761\u3001\u4e00\u6761\u6216\u591a\u6761\u8bb0\u5f55\u3002"),(0,l.kt)("p",null,"\u5728Table API\u4e2d\uff0c\u901a\u8fc7.joinLateral(...) \u6216 .leftOuterJoinLateral(...)\u4f7f\u7528\u8868\u51fd\u6570\u3002\njoinLateral\u64cd\u4f5c\u7b26(cross)\u5c06\u5916\u90e8\u8868(\u64cd\u4f5c\u7b26\u5de6\u4fa7\u7684\u8868)\u4e2d\u7684\u6bcf\u4e00\u884c\u4e0e\u8868\u51fd\u6570(\u64cd\u4f5c\u7b26\u53f3\u4fa7\u7684\u8868\u51fd\u6570)\u4ea7\u751f\u7684\u6240\u6709\u884c\u8fde\u63a5\u8d77\u6765\u3002\nleftOuterJoinLateral\u64cd\u4f5c\u7b26\u5c06\u6765\u81ea\u5916\u90e8\u8868(\u64cd\u4f5c\u7b26\u5de6\u8fb9\u7684\u8868)\u7684\u6bcf\u4e00\u884c\u4e0e\u8868\u503c\u51fd\u6570(\u64cd\u4f5c\u7b26\u53f3\u8fb9\u7684\u8868\u503c\u51fd\u6570)\u4ea7\u751f\u7684\u6240\u6709\u884c\u8fde\u63a5\u8d77\u6765\uff0c\u5e76\u4fdd\u7559\u8868\u51fd\u6570\u8fd4\u56de\u7a7a\u8868\u7684\u5916\u90e8\u884c\u3002"),(0,l.kt)("p",null,"\u5728SQL\u4e2d\uff0c\u4f7f\u7528\u5e26\u6709",(0,l.kt)("inlineCode",{parentName:"p"},"JOIN"),"\u7684",(0,l.kt)("inlineCode",{parentName:"p"},"LATERAL TABLE(<TableFunction>)"),"\u6216\u5e26\u6709",(0,l.kt)("inlineCode",{parentName:"p"},"ON TRUE"),"\u8fde\u63a5\u6761\u4ef6\u7684",(0,l.kt)("inlineCode",{parentName:"p"},"LEFT JOIN"),"\u3002"),(0,l.kt)("p",null,"\u4e0b\u9762\u7684\u793a\u4f8b\u6f14\u793a\u5982\u4f55\u5b9a\u4e49\u81ea\u5df1\u7684split\u51fd\u6570\u5e76\u5728\u67e5\u8be2\u4e2d\u8c03\u7528\u5b83\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'import org.apache.flink.table.annotation.DataTypeHint;\nimport org.apache.flink.table.annotation.FunctionHint;\nimport org.apache.flink.table.api.*;\nimport org.apache.flink.table.functions.TableFunction;\nimport org.apache.flink.types.Row;\n\nimport static org.apache.flink.table.api.Expressions.*;\n\n@FunctionHint(output = @DataTypeHint("ROW<word STRING, length INT>"))\npublic class SplitFunction extends TableFunction<Row> {\n    public void eval(String str) {\n        for (String s : str.split(" ")) {\n            // \u4f7f\u7528collect(...)\u65b9\u6cd5\u53d1\u51farow\u7c7b\u578b\u6570\u636e\n            collect(Row.of(s, s.length()));\n        }\n    }\n}\n\nclass UseFun {\n    public static void main(String[] args) {\n        EnvironmentSettings settings = EnvironmentSettings.newInstance().inStreamingMode().build();\n        TableEnvironment env = TableEnvironment.create(settings);\n        // \u5728Table API\u4e2d\u901a\u8fc7\u5185\u8054\u65b9\u5f0f\u8c03\u7528\u672a\u6ce8\u518c\u7684\u51fd\u6570\n        env\n                .from("MyTable")\n                .joinLateral(call(SplitFunction.class, $("myField")))\n                .select($("myField"), $("word"), $("length"));\n        env\n                .from("MyTable")\n                .leftOuterJoinLateral(call(SplitFunction.class, $("myField")))\n                .select($("myField"), $("word"), $("length"));\n        // \u5728Table API\u4e2d\u91cd\u547d\u540d\u51fd\u6570\u7684\u5c5e\u6027\u540d\n        env\n                .from("MyTable")\n                .leftOuterJoinLateral(call(SplitFunction.class, $("myField")).as("newWord", "newLength"))\n                .select($("myField"), $("newWord"), $("newLength"));\n\n        //\u6ce8\u518c\u51fd\u6570\n        env.createTemporarySystemFunction("SplitFunction", SplitFunction.class);\n        // \u5728Table API\u4e2d\u8c03\u7528\u6ce8\u518c\u7684\u51fd\u6570\n        env\n                .from("MyTable")\n                .joinLateral(call("SplitFunction", $("myField")))\n                .select($("myField"), $("word"), $("length"));\n        env\n                .from("MyTable")\n                .leftOuterJoinLateral(call("SplitFunction", $("myField")))\n                .select($("myField"), $("word"), $("length"));\n        // \u5728SQL\u4e2d\u8c03\u7528\u6ce8\u518c\u7684\u51fd\u6570\n        env.sqlQuery(\n                "SELECT myField, word, length " +\n                        "FROM MyTable, LATERAL TABLE(SplitFunction(myField))");\n        env.sqlQuery(\n                "SELECT myField, word, length " +\n                        "FROM MyTable " +\n                        "LEFT JOIN LATERAL TABLE(SplitFunction(myField)) ON TRUE");\n        // \u5728SQL\u4e2d\u91cd\u547d\u540d\u5c5e\u6027\u503c\n        env.sqlQuery(\n                "SELECT myField, newWord, newLength " +\n                        "FROM MyTable " +\n                        "LEFT JOIN LATERAL TABLE(SplitFunction(myField)) AS T(newWord, newLength) ON TRUE");\n    }\n}\n')),(0,l.kt)("p",null,"\u5982\u679c\u60f3\u5728Scala\u4e2d\u5b9e\u73b0\u51fd\u6570\uff0c\u4e0d\u8981\u5c06\u8868\u51fd\u6570\u5b9e\u73b0\u4e3a",(0,l.kt)("inlineCode",{parentName:"p"},"Scala Object"),"\u3002",(0,l.kt)("inlineCode",{parentName:"p"},"Scala Object"),"\u662f\u5355\u4f8b\u7684\uff0c\u4f1a\u5bfc\u81f4\u5e76\u53d1\u95ee\u9898\u3002"),(0,l.kt)("h2",{id:"\u805a\u5408\u51fd\u6570"},"\u805a\u5408\u51fd\u6570"),(0,l.kt)("p",null,"\u7528\u6237\u81ea\u5b9a\u4e49\u7684\u805a\u5408\u51fd\u6570(UDAGG)\u53ef\u4ee5\u5c06\u591a\u884c\u6807\u91cf\u503c\u6620\u5c04\u5230\u4e00\u4e2a\u65b0\u7684\u6807\u91cf\u503c\u3002"),(0,l.kt)("p",null,"\u805a\u5408\u51fd\u6570\u4f1a\u4f7f\u7528\u5230\u7d2f\u52a0\u5668\u3002\u7d2f\u52a0\u5668\u662f\u4e00\u79cd\u4e2d\u95f4\u6570\u636e\u7ed3\u6784\uff0c\u7528\u4e8e\u5b58\u50a8\u805a\u5408\u503c\uff0c\u76f4\u5230\u8ba1\u7b97\u51fa\u6700\u7ec8\u805a\u5408\u7ed3\u679c\u3002"),(0,l.kt)("p",null,"\u5bf9\u4e8e\u6bcf\u4e00\u7ec4\u9700\u8981\u805a\u5408\u7684\u884c\uff0c\u8fd0\u884c\u65f6\u5c06\u901a\u8fc7\u8c03\u7528",(0,l.kt)("inlineCode",{parentName:"p"},"createAccumulator()"),"\u65b9\u6cd5\u521b\u5efa\u4e00\u4e2a\u7a7a\u7684\u7d2f\u52a0\u5668\u3002\u968f\u540e\uff0c\u5bf9\u6bcf\u4e2a\u8f93\u5165\u884c\u8c03\u7528",(0,l.kt)("inlineCode",{parentName:"p"},"accumulate(...)"),"\u65b9\u6cd5\u6765\u66f4\u65b0\u7d2f\u52a0\u5668\u3002\n\u5904\u7406\u5b8c\u6240\u6709\u884c\u540e\uff0c\u8c03\u7528",(0,l.kt)("inlineCode",{parentName:"p"},"getValue(...)"),"\u65b9\u6cd5\u6765\u8ba1\u7b97\u5e76\u8fd4\u56de\u6700\u7ec8\u7ed3\u679c\u3002"),(0,l.kt)("p",null,"\u4e0b\u56fe\u6f14\u793a\u4e86\u805a\u5408\u8fc7\u7a0b\uff1a"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"img.png",src:t(9930).Z,width:"505",height:"317"})),(0,l.kt)("p",null,"\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u4eec\u5047\u8bbe\u6709\u4e00\u4e2a\u5305\u542b\u996e\u6599\u6570\u636e\u7684\u8868\u3002\u8be5\u8868\u7531\u4e09\u5217",(0,l.kt)("inlineCode",{parentName:"p"},"(id\u3001name\u3001price)"),"\u548c5\u884c\u6570\u636e\u7ec4\u6210\u3002\u6211\u4eec\u60f3\u627e\u51fa\u8868\u4e2d\u6240\u6709\u996e\u6599\u7684\u6700\u9ad8\u4ef7\u683c\uff0c\u5373\u6267\u884cmax()\u805a\u5408\u3002\u6211\u4eec\u9700\u8981\u8ba1\u7b97\u8fd95\u884c\u4e2d\u7684\u6bcf\u4e00\u884c\u3002\u7ed3\u679c\u662f\u4e00\u4e2a\u6807\u91cf\u6570\u503c\u3002"),(0,l.kt)("p",null,"\u4e3a\u4e86\u5b9a\u4e49\u805a\u5408\u51fd\u6570\uff0c\u5fc5\u987b\u6269\u5c55",(0,l.kt)("inlineCode",{parentName:"p"},"org.apache.flink.table.functions"),"\u4e2d\u7684\u57fa\u7c7b",(0,l.kt)("inlineCode",{parentName:"p"},"AggregateFunction"),"\uff0c\u5e76\u5b9e\u73b0\u4e00\u4e2a\u6216\u591a\u4e2a\u540d\u4e3a",(0,l.kt)("inlineCode",{parentName:"p"},"accumulate(...)"),"\u7684\u6c42\u503c\u65b9\u6cd5\u3002\n",(0,l.kt)("inlineCode",{parentName:"p"},"accumulate"),"\u65b9\u6cd5\u5fc5\u987b",(0,l.kt)("strong",{parentName:"p"},"public"),"\uff0c\u800c\u4e0d\u662f\u9759\u6001\u7684\u3002",(0,l.kt)("inlineCode",{parentName:"p"},"accumulate"),"\u65b9\u6cd5\u53ef\u4ee5\u91cd\u8f7d\u3002"),(0,l.kt)("p",null,"\u9ed8\u8ba4\u4f7f\u7528\u53cd\u5c04\u81ea\u52a8\u63d0\u53d6\u8f93\u5165\u3001\u7d2f\u52a0\u5668\u548c\u8f93\u51fa\u6570\u636e\u7c7b\u578b\uff0c\u5305\u62ec\u7d2f\u52a0\u5668\u6cdb\u578bACC\u548c\u8fd4\u56de\u7ed3\u679c\u6cdb\u578bT\u3002\u8f93\u5165\u53c2\u6570\u6765\u81ea\u4e00\u4e2a\u6216\u591a\u4e2a",(0,l.kt)("inlineCode",{parentName:"p"},"accumulate(...)"),"\u65b9\u6cd5\u3002"),(0,l.kt)("p",null,"\u4e0b\u9762\u7684\u793a\u4f8b\u6f14\u793a\u5982\u4f55\u5b9a\u4e49\u81ea\u5df1\u7684\u805a\u5408\u51fd\u6570\u5e76\u5728\u67e5\u8be2\u4e2d\u8c03\u7528\u5b83\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'    import org.apache.flink.table.api.*;\nimport org.apache.flink.table.functions.AggregateFunction;\n\nimport static org.apache.flink.table.api.Expressions.*;\n\n// \u81ea\u5b9a\u4e49\u805a\u5408\u51fd\u6570\u7684\u53ef\u53d8\u7d2f\u52a0\u5668\npublic class WeightedAvgAccumulator {\n    public long sum = 0;\n    public int count = 0;\n}\n\n// \u7b2c\u4e00\u4e2a\u6cdb\u578b\u8868\u793a\u805a\u5408\u7ed3\u679c\u7c7b\u578b\uff0c\u4e5f\u5c31\u662f\u8fd4\u56de\u503c\u7c7b\u578b\uff0c\u7b2c\u4e8c\u4e2a\u6cdb\u578b\u8868\u793a\u7d2f\u52a0\u5668\u7c7b\u578b\npublic class WeightedAvg extends AggregateFunction<Long, WeightedAvgAccumulator> {\n    /**\n     * \u521b\u5efa\u5e76\u521d\u59cb\u5316\u7d2f\u52a0\u5668\n     * \u7d2f\u52a0\u5668\u662f\u8ba1\u7b97\u4e2d\u95f4\u7ed3\u679c\u7684\u6570\u636e\u7ed3\u6784\u4f53\uff0c\u5b58\u50a8\u805a\u5408\u6570\u636e\u503c\uff0c\u76f4\u5230\u8ba1\u7b97\u6700\u7ec8\u805a\u5408\u7ed3\u679c\u3002\n     *\n     * @return \u5177\u6709\u521d\u59cb\u5316\u503c\u7684\u7d2f\u52a0\u5668\n     */\n    @Override\n    public WeightedAvgAccumulator createAccumulator() {\n        return new WeightedAvgAccumulator();\n    }\n\n    /**\n     * \u8ba1\u7b97\u5e76\u8fd4\u56de\u6700\u7ec8\u7ed3\u679c\n     */\n    @Override\n    public Long getValue(WeightedAvgAccumulator acc) {\n        if (acc.count == 0) {\n            return null;\n        } else {\n            return acc.sum / acc.count;\n        }\n    }\n\n    /**\n     * \u5904\u7406\u8f93\u5165\u53c2\u6570\u503c\uff0c\u5e76\u4e14\u66f4\u65b0\u63d0\u4f9b\u7684\u7d2f\u52a0\u5668\u5b9e\u4f8b\u3002\n     * \u8fd9\u4e2a\u65b9\u6cd5\u53ef\u4ee5\u88ab\u91cd\u8f7d\u3002\n     * \u81ea\u5b9a\u4e49\u805a\u5408\u51fd\u6570\u5fc5\u987b\u6709\u81f3\u5c11\u4e00\u4e2aaccumulate()\u65b9\u6cd5\u3002\n     *\n     * @param acc \u5305\u542b\u5f53\u524d\u805a\u5408\u7ed3\u679c\u7684\u7d2f\u52a0\u5668\n     * @param iValue \u7528\u6237\u8f93\u5165\u53c2\u6570\n     * @param iWeight \u7528\u6237\u8f93\u5165\u53c2\u6570\n     */\n    public void accumulate(WeightedAvgAccumulator acc, Long iValue, Integer iWeight) {\n        acc.sum += iValue * iWeight;\n        acc.count += iWeight;\n    }\n\n    /**\n     * \u4ece\u7d2f\u52a0\u5668\u5b9e\u4f8b\u64a4\u56de\u8f93\u5165\u503c\u3002\n     * \u5f53\u524d\u8bbe\u8ba1\u5047\u5b9a\u8be5\u8f93\u5165\u503c\u662f\u4ee5\u524d\u7d2f\u52a0\u8fc7\u7684\u503c\u3002\n     * \u8be5\u65b9\u6cd5\u53ef\u4ee5\u88ab\u91cd\u8f7d\u3002\n     * \u5728\u65e0\u754c\u8868\u4e0a\u4f7f\u7528\u6709\u754cOVER\u805a\u5408\u6570\u636e\u65f6\uff0c\u5fc5\u987b\u5b9e\u73b0\u8be5\u65b9\u6cd5\u3002\n     *\n     * @param acc \u5305\u542b\u5f53\u524d\u805a\u5408\u7ed3\u679c\u7684\u7d2f\u52a0\u5668\n     * @param iValue \u7528\u6237\u8f93\u5165\u53c2\u6570\n     * @param iWeight \u7528\u6237\u8f93\u5165\u53c2\u6570\n     */\n    public void retract(WeightedAvgAccumulator acc, Long iValue, Integer iWeight) {\n        acc.sum -= iValue * iWeight;\n        acc.count -= iWeight;\n    }\n\n    /**\n     * \u5c06\u4e00\u7ec4\u7d2f\u52a0\u5668\u5b9e\u4f8b\u805a\u5408\u5230\u4e00\u4e2a\u7d2f\u52a0\u5668\u5b9e\u4f8b\u3002\n     * \u5728\u65e0\u754c\u4f1a\u8bdd\u7a97\u53e3\u3001\u6ed1\u52a8\u7a97\u53e3\u8fdb\u884c\u5206\u7ec4\u805a\u5408\uff0c\u4ee5\u53ca\u5728\u6709\u754c\u5206\u533a\u805a\u5408\u65f6\u5fc5\u987b\u5b9e\u73b0\u8be5\u65b9\u6cd5\u3002\n     * \u9664\u6b64\u4e4b\u5916\uff0c\u5b9e\u73b0\u8be5\u65b9\u6cd5\u5bf9\u4f18\u5316\u5668\u662f\u6709\u5e2e\u52a9\u7684\u3002\n     * \u6bd4\u5982\uff0c\u4e24\u9636\u6bb5\u805a\u5408\u4f18\u5316\u8981\u6c42\u6240\u6709\u805a\u5408\u51fd\u6570\u652f\u6301\u201cmerge\u201d\u65b9\u6cd5\n     *\n     * @param acc \u4fdd\u5b58\u805a\u5408\u7ed3\u679c\u7684\u7d2f\u52a0\u5668\u3002\u6ce8\u610f\uff0c\u5b83\u5e94\u8be5\u5305\u542b\u4e4b\u524d\u805a\u5408\u7684\u7ed3\u679c\uff0c\u56e0\u6b64\uff0c\u6211\u4eec\u4e0d\u80fd\u5728\u805a\u5408\u65b9\u6cd5\u4e2d\u66ff\u6362\u6216\u6e05\u7406\u8fd9\u4e2a\u5b9e\u4f8b\u3002\n     * @param it \u4e00\u7ec4\u5c06\u88ab\u5408\u5e76\u7684\u7d2f\u52a0\u5668\u5bf9\u5e94\u7684\u8fed\u4ee3\u5668\n     */\n    public void merge(WeightedAvgAccumulator acc, Iterable<WeightedAvgAccumulator> it) {\n        for (WeightedAvgAccumulator a : it) {\n            acc.count += a.count;\n            acc.sum += a.sum;\n        }\n    }\n\n    /**\n     * \u91cd\u7f6e\u7d2f\u52a0\u5668\n     */\n    public void resetAccumulator(WeightedAvgAccumulator acc) {\n        acc.count = 0;\n        acc.sum = 0L;\n    }\n}\n\nclass useFun {\n    public static void main(String[] args) {\n        EnvironmentSettings settings = EnvironmentSettings.newInstance().inStreamingMode().build();\n        TableEnvironment env = TableEnvironment.create(settings);\n        // \u5728Table API\u4e2d\u8c03\u7528\u672a\u88ab\u6ce8\u518c\u7684\u51fd\u6570\n        env\n                .from("MyTable")\n                .groupBy($("myField"))\n                .select($("myField"), call(WeightedAvg.class, $("value"), $("weight")));\n        // \u6ce8\u518c\u51fd\u6570\n        env.createTemporarySystemFunction("WeightedAvg", WeightedAvg.class);\n        // \u5728Table API\u4e2d\u8c03\u7528\u6ce8\u518c\u7684\u51fd\u6570\n        env\n                .from("MyTable")\n                .groupBy($("myField"))\n                .select($("myField"), call("WeightedAvg", $("value"), $("weight")));\n        // \u5728SQL\u4e2d\u8c03\u7528\u6ce8\u518c\u7684\u51fd\u6570\n        env.sqlQuery(\n                "SELECT myField, WeightedAvg(`value`, weight) FROM MyTable GROUP BY myField"\n        );\n    }\n}\n\n')),(0,l.kt)("p",null,"WeightedAvg\u7c7b\u7684",(0,l.kt)("inlineCode",{parentName:"p"},"accumulate(...)"),"\u65b9\u6cd5\u63a5\u53d7\u4e09\u4e2a\u8f93\u5165\u53c2\u6570\u3002\u7b2c\u4e00\u4e2a\u662f\u7d2f\u52a0\u5668\uff0c\u53e6\u5916\u4e24\u4e2a\u662f\u7528\u6237\u81ea\u5b9a\u4e49\u7684\u8f93\u5165\u3002\u4e3a\u4e86\u8ba1\u7b97\u52a0\u6743\u5e73\u5747\u503c\uff0c\u7d2f\u52a0\u5668\u9700\u8981\u5b58\u50a8\u5df2\u7d2f\u79ef\u7684\u6240\u6709\u6570\u636e\u7684\u52a0\u6743\u548c\u8ba1\u6570\u3002\n\u5728\u6211\u4eec\u7684\u793a\u4f8b\u4e2d\uff0c\u6211\u4eec\u5b9a\u4e49\u4e86\u4e00\u4e2a\u7c7bWeightedAvgAccumulator\u4f5c\u4e3a\u7d2f\u52a0\u5668\u3002\u7d2f\u52a0\u5668\u7531Flink\u7684checkpoint\u673a\u5236\u81ea\u52a8\u7ba1\u7406\uff0c\u5e76\u5728\u51fa\u73b0\u9519\u8bef\u65f6\u6062\u590d\uff0c\u4ee5\u786e\u4fdd\u6070\u597d\u4e00\u6b21\u8bed\u4e49\u3002"),(0,l.kt)("h3",{id:"\u5fc5\u9009\u548c\u53ef\u9009\u65b9\u6cd5"},"\u5fc5\u9009\u548c\u53ef\u9009\u65b9\u6cd5"),(0,l.kt)("p",null,"\u5bf9\u4e8e\u6bcf\u4e2a\u81ea\u5b9a\u4e49AggregateFunction\u51fd\u6570\uff0c\u4ee5\u4e0b\u65b9\u6cd5\u662f\u5fc5\u987b\u5b9e\u73b0\u7684\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"createAccumulator()"),(0,l.kt)("li",{parentName:"ul"},"accumulate(...)"),(0,l.kt)("li",{parentName:"ul"},"getValue(...)")),(0,l.kt)("p",null,"\u6b64\u5916\uff0c\u8fd8\u6709\u4e00\u4e9b\u53ef\u9009\u7684\u65b9\u6cd5\u53ef\u4ee5\u5b9e\u73b0\u3002\u867d\u7136\u5176\u4e2d\u4e00\u4e9b\u65b9\u6cd5\u53ea\u662f\u4e3a\u4e86\u8ba9\u7cfb\u7edf\u66f4\u6709\u6548\u5730\u6267\u884c\u67e5\u8be2\uff0c\u4f46\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u5219\u5fc5\u9700\u5b9e\u73b0\u7684\u3002\n\u4f8b\u5982\uff0c\u5982\u679c\u5728",(0,l.kt)("inlineCode",{parentName:"p"},"\u4f1a\u8bdd\u5206\u7ec4\u7a97\u53e3\uff08session group window\uff09"),"\u4e0a\u8c03\u7528\u805a\u5408\u51fd\u6570\uff0c\u5219",(0,l.kt)("strong",{parentName:"p"},"merge(...)"),"\u65b9\u6cd5\u662f\u5f3a\u5236\u6027\u7684(\u5f53\u201c\u8fde\u63a5\u201d\u4e24\u4e2a\u4f1a\u8bdd\u7a97\u53e3\u7684\u6570\u636e\u884c\u65f6\uff0c\u9700\u8981\u8fde\u63a5\u4e24\u4e2a\u4f1a\u8bdd\u7a97\u53e3\u7684\u7d2f\u52a0\u5668)\u3002"),(0,l.kt)("p",null,"AggregateFunction\u7684\u4ee5\u4e0b\u65b9\u6cd5\u5b9e\u73b0\u53d6\u51b3\u4e8e\u4f7f\u7528\u60c5\u5883\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"retract(...)\uff1a\u5728OVER\u7a97\u53e3\u4e0a\u8fdb\u884c\u805a\u5408\u65f6\u9700\u8981\u4f7f\u7528\u3002"),(0,l.kt)("li",{parentName:"ul"},"merge(...)\uff1a\u5bf9\u4e8e\u8bb8\u591a\u6709\u754c\u805a\u5408\u3001\u4f1a\u8bdd\u7a97\u53e3\u548c\u6ed1\u52a8\u7a97\u53e3\u805a\u5408\u90fd\u662f\u5fc5\u9700\u7684\u3002\u6b64\u5916\uff0c\u8be5\u65b9\u6cd5\u4e5f\u6709\u52a9\u4e8e\u67e5\u8be2\u4f18\u5316\u3002\u4f8b\u5982\uff0c\u4e24\u9636\u6bb5\u805a\u5408\u4f18\u5316\u8981\u6c42\u6240\u6709AggregateFunction\u652f\u6301merge\u65b9\u6cd5\u3002\n\u4e24\u9636\u6bb5\u805a\u5408\uff1a\u7c7b\u4f3c\u4e8eMR\u4e2d\u7684combiner\uff0c\u5148\u5728map\u7aef\u8fdb\u884c\u5c0f\u7684\u805a\u5408\uff0c\u6700\u540e\u5728reduce\u7aef\u518d\u6b21\u805a\u5408\u3002")),(0,l.kt)("p",null,"\u5982\u679c\u805a\u5408\u51fd\u6570\u53ea\u80fd\u5728OVER\u7a97\u53e3\u4e2d\u4f7f\u7528\uff0c\u5219\u53ef\u4ee5\u901a\u8fc7\u8fd4\u56de",(0,l.kt)("inlineCode",{parentName:"p"},"FunctionRequirement"),"\u6765\u58f0\u660e\u3002\u5728",(0,l.kt)("inlineCode",{parentName:"p"},"getRequirements()"),"\u4e2d\u8fd4\u56de",(0,l.kt)("inlineCode",{parentName:"p"},"FunctionRequirement.OVER_WINDOW_ONLY"),"\u3002\n\u5982\u679c\u7d2f\u52a0\u5668\u9700\u8981\u5b58\u50a8\u5927\u91cf\u7684\u6570\u636e\uff0c\u5219\u4f7f\u7528",(0,l.kt)("inlineCode",{parentName:"p"},"org.apache.flink.table.api.dataview.ListView"),"\u548c",(0,l.kt)("inlineCode",{parentName:"p"},"org.apache.flink.table.api.dataview.MapView"),"\n\u63d0\u4f9b\u7684\u9ad8\u7ea7\u7279\u6027\uff0c\u5728\u65e0\u754c\u6570\u636e\u573a\u666f\u4e2d\u5229\u7528Flink\u7684\u72b6\u6001\u540e\u7aef\u3002\u6709\u5173\u8fd9\u4e2a\u9ad8\u7ea7\u7279\u6027\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605\u76f8\u5e94\u7c7b\u7684\u6587\u6863\u3002"),(0,l.kt)("p",null,"\u7531\u4e8e\u6709\u4e9b\u65b9\u6cd5\u662f\u53ef\u9009\u7684\uff0c\u6216\u8005\u662f\u53ef\u4ee5\u91cd\u8f7d\uff0c\u6240\u4ee5\u8fd0\u884c\u65f6\u662f\u901a\u8fc7\u751f\u6210\u7684\u4ee3\u7801\u6765\u8c03\u7528\u805a\u5408\u51fd\u6570\u65b9\u6cd5\u7684\u3002\u8fd9\u610f\u5473\u7740\u57fa\u7c7b\u5e76\u4e0d\u603b\u662f\u63d0\u4f9b\u5177\u4f53\u65b9\u6cd5\u5b9e\u73b0\u9700\u8981\u8986\u76d6\u7684\u7b7e\u540d\u3002\u7136\u800c\uff0c\u6240\u6709\u63d0\u5230\u7684\u65b9\u6cd5\u90fd\u5fc5\u987b\u516c\u5f00\u7684\uff0c\u800c\u4e14\u4e0d\u662f\u9759\u6001\u7684\uff0c\u5e76\u4e14\u5b8c\u5168\u6309\u7167\u4e0a\u9762\u63d0\u5230\u7684\u65b9\u6cd5\u7684\u540d\u5b57\u547d\u540d\u3002"),(0,l.kt)("p",null,"\u4e0b\u9762\u7ed9\u51fa\u672a\u5728AggregateFunction\u4e2d\u58f0\u660e\u5e76\u7531\u751f\u6210\u7684\u4ee3\u7801\u8c03\u7528\u7684\u6240\u6709\u65b9\u6cd5\u7684\u8be6\u7ec6\u6587\u6863\u3002"),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"accumulate(...)\uff1a")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * \u5904\u7406\u8f93\u5165\u53c2\u6570\u503c\uff0c\u5e76\u4e14\u66f4\u65b0\u63d0\u4f9b\u7684\u7d2f\u52a0\u5668\u5b9e\u4f8b\u3002\n * \u8fd9\u4e2a\u65b9\u6cd5\u53ef\u4ee5\u88ab\u91cd\u8f7d\u3002\n * \u81ea\u5b9a\u4e49\u805a\u5408\u51fd\u6570\u5fc5\u987b\u6709\u81f3\u5c11\u4e00\u4e2aaccumulate()\u65b9\u6cd5\u3002\n *\n * @param acc \u5305\u542b\u5f53\u524d\u805a\u5408\u7ed3\u679c\u7684\u7d2f\u52a0\u5668\n * @param: [user defined inputs] \u8f93\u5165\u503c\uff08\u901a\u5e38\u662f\u65b0\u5230\u8fbe\u6570\u636e\u884c\u5b57\u6bb5\uff09\n **/\npublic void accumulate(ACC accumulator,[user defined inputs])\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"retract(...)\uff1a")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * \u4ece\u7d2f\u52a0\u5668\u5b9e\u4f8b\u64a4\u56de\u8f93\u5165\u503c\u3002\n * \u5f53\u524d\u8bbe\u8ba1\u5047\u5b9a\u8be5\u8f93\u5165\u503c\u662f\u4ee5\u524d\u7d2f\u52a0\u8fc7\u7684\u503c\u3002\n * \u8be5\u65b9\u6cd5\u53ef\u4ee5\u88ab\u91cd\u8f7d\u3002\n * \u5728\u65e0\u754c\u8868\u4e0a\u4f7f\u7528\u6709\u754cOVER\u805a\u5408\u6570\u636e\u65f6\uff0c\u5fc5\u987b\u5b9e\u73b0\u8be5\u65b9\u6cd5\u3002\n * @param accumulator \u5305\u542b\u5f53\u524d\u805a\u5408\u7ed3\u679c\u7684\u7d2f\u52a0\u5668\n * @param [user defined inputs] \u8f93\u5165\u503c\uff08\u901a\u5e38\u662f\u65b0\u5230\u8fbe\u6570\u636e\u884c\u5b57\u6bb5\uff09\n */\npublic void retract(ACC accumulator,[user defined inputs])\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"merge(...)\uff1a")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * \u5c06\u4e00\u7ec4\u7d2f\u52a0\u5668\u5b9e\u4f8b\u805a\u5408\u5230\u4e00\u4e2a\u7d2f\u52a0\u5668\u5b9e\u4f8b\u3002\n * \u5728\u65e0\u754c\u4f1a\u8bdd\u7a97\u53e3\u3001\u6ed1\u52a8\u7a97\u53e3\u8fdb\u884c\u5206\u7ec4\u805a\u5408\uff0c\u4ee5\u53ca\u5728\u6709\u754c\u5206\u533a\u805a\u5408\u65f6\u5fc5\u987b\u5b9e\u73b0\u8be5\u65b9\u6cd5\u3002\n * \u9664\u6b64\u4e4b\u5916\uff0c\u5b9e\u73b0\u8be5\u65b9\u6cd5\u5bf9\u4f18\u5316\u5668\u662f\u6709\u5e2e\u52a9\u7684\u3002\n * \u6bd4\u5982\uff0c\u4e24\u9636\u6bb5\u805a\u5408\u4f18\u5316\u8981\u6c42\u6240\u6709\u805a\u5408\u51fd\u6570\u652f\u6301\u201cmerge\u201d\u65b9\u6cd5\n *\n * @param accumulator \u4fdd\u5b58\u805a\u5408\u7ed3\u679c\u7684\u7d2f\u52a0\u5668\u3002\u6ce8\u610f\uff0c\u5b83\u5e94\u8be5\u5305\u542b\u4e4b\u524d\u805a\u5408\u7684\u7ed3\u679c\uff0c\u56e0\u6b64\uff0c\u6211\u4eec\u4e0d\u80fd\u5728\u805a\u5408\u65b9\u6cd5\u4e2d\u66ff\u6362\u6216\u6e05\u7406\u8fd9\u4e2a\u5b9e\u4f8b\u3002\n * @param iterable \u4e00\u7ec4\u5c06\u88ab\u5408\u5e76\u7684\u7d2f\u52a0\u5668\u5bf9\u5e94\u7684\u8fed\u4ee3\u5668\n */\npublic void merge(ACC accumulator,java.lang.Iterable<ACC> iterable)\n")),(0,l.kt)("h2",{id:"\u8868\u805a\u5408\u51fd\u6570"},"\u8868\u805a\u5408\u51fd\u6570"),(0,l.kt)("p",null,"\u7528\u6237\u5b9a\u4e49\u7684\u8868\u805a\u5408\u51fd\u6570(UDTAGG)\u53ef\u4ee5\u5c06\u591a\u884c\u6807\u91cf\u503c\u6620\u5c04\u4e3a0\u30011\u6216\u591a\u884c(\u6216\u7ed3\u6784\u5316\u7c7b\u578b)\u6807\u91cf\u503c\u3002\u8fd4\u56de\u7684\u8bb0\u5f55\u53ef\u4ee5\u7531\u4e00\u4e2a\u6216\u591a\u4e2a\u5b57\u6bb5\u7ec4\u6210\u3002\u5982\u679c\u8f93\u51fa\u8bb0\u5f55\u53ea\u5305\u542b\u4e00\u4e2a\u5b57\u6bb5\uff0c\u5219\u53ef\u4ee5\u7701\u7565\u7ed3\u6784\u5316\uff0c\u5e76\u4e14\u53d1\u51fa\u4e00\u4e2a\u6807\u91cf\u503c\uff0c\u8be5\u6807\u91cf\u503c\u5c06\u7531\u8fd0\u884c\u65f6\u9690\u5f0f\u5305\u88c5\u5230row\u4e2d\u3002"),(0,l.kt)("p",null,"\u4e0e\u805a\u5408\u51fd\u6570\u7c7b\u4f3c\uff0c\u8868\u805a\u5408\u7684\u884c\u4e3a\u4ee5\u7d2f\u52a0\u5668\u7684\u6982\u5ff5\u4e3a\u4e2d\u5fc3\u3002\u7d2f\u52a0\u5668\u662f\u4e2d\u95f4\u6570\u636e\u7ed3\u6784\uff0c\u7528\u4e8e\u5b58\u50a8\u805a\u5408\u503c\uff0c\u76f4\u5230\u8ba1\u7b97\u51fa\u6700\u7ec8\u805a\u5408\u7ed3\u679c\u3002"),(0,l.kt)("p",null,"\u5bf9\u4e8e\u6bcf\u4e00\u7ec4\u9700\u8981\u805a\u5408\u7684\u884c\uff0c\u8fd0\u884c\u65f6\u5c06\u901a\u8fc7\u8c03\u7528",(0,l.kt)("inlineCode",{parentName:"p"},"createAccumulator()"),"\u521b\u5efa\u4e00\u4e2a\u7a7a\u7684\u7d2f\u52a0\u5668\u3002\u968f\u540e\uff0c\u5bf9\u6bcf\u4e2a\u8f93\u5165\u884c\u8c03\u7528\u51fd\u6570\u7684",(0,l.kt)("inlineCode",{parentName:"p"},"accumulate(...)"),"\u65b9\u6cd5\u6765\u66f4\u65b0\u7d2f\u52a0\u5668\u3002\n\u5904\u7406\u5b8c\u6240\u6709\u884c\u540e\uff0c\u8c03\u7528\u51fd\u6570\u7684",(0,l.kt)("inlineCode",{parentName:"p"},"emitValue(...)"),"\u6216",(0,l.kt)("inlineCode",{parentName:"p"},"emitUpdateWithRetract(...)"),"\u65b9\u6cd5\u6765\u8ba1\u7b97\u5e76\u8fd4\u56de\u6700\u7ec8\u7ed3\u679c\u3002"),(0,l.kt)("p",null,"\u4e0b\u56fe\u6f14\u793a\u4e86\u805a\u5408\u8fc7\u7a0b\uff1a"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"img.png",src:t(8148).Z,width:"530",height:"270"})),(0,l.kt)("p",null,"\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u4eec\u5047\u8bbe\u4e00\u4e2a\u5305\u542b\u996e\u6599\u6570\u636e\u7684\u8868\u3002\u8be5\u8868\u7531\u4e09\u5217",(0,l.kt)("inlineCode",{parentName:"p"},"(id\u3001name\u3001price)"),"\u548c5\u884c\u6570\u636e\u7ec4\u6210\u3002\u6211\u4eec\u60f3\u5728\u8868\u683c\u4e2d\u627e\u51fa\u6240\u6709\u996e\u6599\u6700\u9ad8\u76842\u4e2a\u4ef7\u683c\uff0c\u5373\u6267\u884cTOP2()\u8868\u683c\u6c47\u603b\u3002\u6211\u4eec\u9700\u8981\u8ba1\u7b97\u8fd95\u884c\u4e2d\u7684\u6bcf\u4e00\u884c\u3002\u7ed3\u679c\u662f\u4e00\u4e2a\u5305\u542b\u524d2\u4e2a\u503c\u7684\u8868\u3002"),(0,l.kt)("p",null,"\u4e3a\u4e86\u5b9a\u4e49\u8868\u805a\u5408\u51fd\u6570\uff0c\u5fc5\u987b\u6269\u5c55",(0,l.kt)("inlineCode",{parentName:"p"},"org.apache.flink.table.functions"),"\u4e2d\u7684\u57fa\u7c7b",(0,l.kt)("strong",{parentName:"p"},"TableAggregateFunction"),"\uff0c\u5e76\u5b9e\u73b0\u4e00\u4e2a\u6216\u591a\u4e2a\u540d\u4e3a",(0,l.kt)("inlineCode",{parentName:"p"},"accumulate(...)"),"\u7684\u6c42\u503c\u65b9\u6cd5\u3002\n",(0,l.kt)("inlineCode",{parentName:"p"},"accumulate"),"\u65b9\u6cd5\u5fc5\u987b",(0,l.kt)("strong",{parentName:"p"},"public"),"\uff0c\u800c\u4e14\u662f\u975e\u9759\u6001\u7684\u3002\u7d2f\u52a0\u65b9\u6cd5\u4e5f\u53ef\u4ee5\u901a\u8fc7\u5b9e\u73b0\u591a\u4e2a\u540d\u4e3a",(0,l.kt)("inlineCode",{parentName:"p"},"accumulate"),"\u7684\u65b9\u6cd5\u6765\u91cd\u8f7d\u3002"),(0,l.kt)("p",null,"\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4f7f\u7528\u53cd\u5c04\u81ea\u52a8\u63d0\u53d6\u8f93\u5165\u3001\u7d2f\u52a0\u5668\u548c\u8f93\u51fa\u6570\u636e\u7c7b\u578b\u3002\u8fd9\u5305\u62ec\u786e\u5b9a\u7d2f\u52a0\u5668\u6cdb\u578b\u53c2\u6570ACC\u548c\u7d2f\u52a0\u5668\u7ed3\u679c\u6cdb\u578b\u53c2\u6570T\u3002\u8f93\u5165\u53c2\u6570\u6765\u81ea\u4e00\u4e2a\u6216\u591a\u4e2a",(0,l.kt)("inlineCode",{parentName:"p"},"accumulate(...)"),"\u65b9\u6cd5\u3002"),(0,l.kt)("p",null,"\u5982\u679c\u6253\u7b97\u5728Python\u4e2d\u5b9e\u73b0\u6216\u8c03\u7528\u51fd\u6570\uff0c\u8bf7\u53c2\u9605Python\u51fd\u6570\u6587\u6863\u4e86\u89e3\u66f4\u591a\u7ec6\u8282\u3002"),(0,l.kt)("p",null,"\u4e0b\u9762\u7684\u793a\u4f8b\u6f14\u793a\u5982\u4f55\u5b9a\u4e49\u81ea\u5df1\u7684\u8868\u805a\u5408\u51fd\u6570\u5e76\u5728\u67e5\u8be2\u4e2d\u8c03\u7528\u5b83\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'import org.apache.flink.api.java.tuple.Tuple2;\nimport org.apache.flink.table.api.*;\nimport org.apache.flink.table.functions.TableAggregateFunction;\nimport org.apache.flink.util.Collector;\n\nimport static org.apache.flink.table.api.Expressions.*;\n\n// \u81ea\u5b9a\u4e49\u8868\u805a\u5408\u51fd\u6570\u7684\u53ef\u53d8\u7d2f\u52a0\u5668\npublic class Top2Accumulator {\n    public Integer first;\n    public Integer second;\n}\n\n// \u51fd\u6570\u5305\u542b\u7528\u6237\u8f93\u5165\u503c\uff08INT\uff09\uff0c\u4fdd\u5b58\u4e2d\u95f4\u7ed3\u679c\u5230Top2Accumulator\u5bf9\u8c61\uff0c\u6700\u540e\u8fd4\u56deTuple2<Integer, Integer>\u7c7b\u578b\u7684\u7ed3\u679c\uff0c\u7b2c\u4e00\u4e2a\u8868\u793a\u7ed3\u679c\u503c\uff0c\u7b2c\u4e8c\u4e2a\u8868\u793a\u7ea7\u522b\u3002\n// \u51fd\u6570\u7b2c\u4e00\u4e2a\u6cdb\u578b\u8868\u793a\u805a\u5408\u7ed3\u679c\u7c7b\u578b\uff0c\u7b2c\u4e8c\u4e2a\u6cdb\u578b\u8868\u793a\u7d2f\u52a0\u5668\u7c7b\u578b\npublic class Top2 extends TableAggregateFunction<Tuple2<Integer, Integer>, Top2Accumulator> {\n    /**\n     * \u521b\u5efa\u4e00\u4e2a\u521d\u59cb\u5316\u7684\u7d2f\u52a0\u5668\n     *\n     * @return \u521d\u59cb\u5316\u7684\u7d2f\u52a0\u5668\n     */\n    @Override\n    public Top2Accumulator createAccumulator() {\n        Top2Accumulator acc = new Top2Accumulator();\n        acc.first = Integer.MIN_VALUE;\n        acc.second = Integer.MIN_VALUE;\n        return acc;\n    }\n\n    /**\n     * \u5904\u7406\u8f93\u5165\u503c\uff0c\u5e76\u4e14\u66f4\u65b0\u4e4b\u524d\u7684\u7d2f\u52a0\u5668\u5b9e\u4f8b\u3002\u8fd9\u4e2a\u65b9\u6cd5\u53ef\u4ee5\u88ab\u91cd\u8f7d\u3002\u8868\u805a\u5408\u51fd\u6570\u8981\u6c42\u81f3\u5c11\u4e00\u4e2aaccumulate()\u65b9\u6cd5\u3002\n     *\n     * @param acc \u5305\u542b\u5f53\u524d\u805a\u5408\u7ed3\u679c\u7684\u7d2f\u52a0\u5668\n     * @param value \u8f93\u5165\u503c\uff08\u901a\u5e38\u662f\u7528\u6237\u8f93\u5165\u7684\u6570\u636e\uff09\n     */\n    public void accumulate(Top2Accumulator acc, Integer value) {\n        if (value > acc.first) {\n            acc.second = acc.first;\n            acc.first = value;\n        } else if (value > acc.second) {\n            acc.second = value;\n        }\n    }\n\n    /**\n     * \u5408\u5e76\u4e00\u7ec4\u7d2f\u52a0\u5668\u5b9e\u4f8b\u5230\u4e00\u4e2a\u7d2f\u52a0\u5668\u5b9e\u4f8b\u3002\u8fd9\u4e2a\u65b9\u6cd5\u5fc5\u987b\u5728\u65e0\u754c\u4f1a\u8bdd\u3001\u6ed1\u52a8\u7a97\u53e3\u5206\u7ec4\u805a\u5408\u3001\u6709\u754c\u5206\u7ec4\u805a\u5408\u4e2d\u5b9e\u73b0\u3002\n     *\n     * @param acc \u5c06\u8981\u4fdd\u5b58\u805a\u5408\u7ed3\u679c\u7684\u7d2f\u52a0\u5668\u3002\u8fd9\u4e2a\u7d2f\u52a0\u5668\u53ef\u80fd\u5305\u542b\u4e4b\u524d\u805a\u5408\u7684\u7ed3\u679c\uff0c\u56e0\u6b64\u7528\u6237\u4e0d\u80fd\u66ff\u6362\uff0c\u6216\u8005\u662f\u6e05\u7406\u8fd9\u4e2a\u5b9e\u4f8b\u3002\n     * @param it \u5c06\u8981\u88ab\u5408\u5e76\u7684\u4e00\u7ec4\u7d2f\u52a0\u5668\u5bf9\u5e94\u7684\u8fed\u4ee3\u5668\n     */\n    public void merge(Top2Accumulator acc, Iterable<Top2Accumulator> it) {\n        for (Top2Accumulator otherAcc : it) {\n            accumulate(acc, otherAcc.first);\n            accumulate(acc, otherAcc.second);\n        }\n    }\n\n    /**\n     * \u6bcf\u6b21\u805a\u5408\u7ed3\u679c\u5e94\u8be5\u88ab\u7269\u5316\u65f6\u8c03\u7528\u3002\u8fd4\u56de\u503c\u53ef\u4ee5\u662f\u65e9\u671f\u672a\u5b8c\u6210\u7684\u7ed3\u679c\uff08\u5f53\u6570\u636e\u5230\u8fbe\u65f6\u5b9a\u671f\u53d1\u51fa\uff09\uff0c\u6216\u8005\u662f\u6700\u7ec8\u7684\u805a\u5408\u7ed3\u679c\u3002\n     *\n     * @param acc \u5305\u542b\u5f53\u524d\u805a\u5408\u7ed3\u679c\u7684\u7d2f\u52a0\u5668\u3002\n     * @param out \u8f93\u51fa\u6570\u636e\u7684\u6536\u96c6\u5668\u3002\n     */\n    public void emitValue(Top2Accumulator acc, Collector<Tuple2<Integer, Integer>> out) {\n        // emit the value and rank\n        if (acc.first != Integer.MIN_VALUE) {\n            out.collect(Tuple2.of(acc.first, 1));\n        }\n        if (acc.second != Integer.MIN_VALUE) {\n            out.collect(Tuple2.of(acc.second, 2));\n        }\n    }\n}\n\nclass UseFun {\n    public static void main(String[] args) {\n\n\n        EnvironmentSettings settings = EnvironmentSettings.newInstance().inStreamingMode().build();\n        TableEnvironment env = TableEnvironment.create(settings);\n        // \u5728Table API\u4e2d\u901a\u8fc7\u5185\u8054\u65b9\u5f0f\u8c03\u7528\u672a\u88ab\u6ce8\u518c\u7684\u51fd\u6570\n        env\n                .from("MyTable")\n                .groupBy($("myField"))\n                .flatAggregate(call(Top2.class, $("value")))\n                .select($("myField"), $("f0"), $("f1"));\n        // \u5728Table API\u4e2d\u901a\u8fc7\u5185\u8054\u65b9\u5f0f\u8c03\u7528\u672a\u88ab\u6ce8\u518c\u7684\u51fd\u6570\uff0c\u5e76\u4e14\u4f7f\u7528\u522b\u540d\u6765\u66f4\u597d\u7684\u6807\u8bc6\u8fd4\u56de\u503c\u4e8c\u5143\u7ec4\u7684\u5c5e\u6027\n        env\n                .from("MyTable")\n                .groupBy($("myField"))\n                .flatAggregate(call(Top2.class, $("value")).as("value", "rank"))\n                .select($("myField"), $("value"), $("rank"));\n        // \u6ce8\u518c\u51fd\u6570\n        env.createTemporarySystemFunction("Top2", Top2.class);\n        //\u5728Table API\u4e2d\u8c03\u7528\u6ce8\u518c\u7684\u51fd\u6570\n        env\n                .from("MyTable")\n                .groupBy($("myField"))\n                .flatAggregate(call("Top2", $("value")).as("value", "rank"))\n                .select($("myField"), $("value"), $("rank"));\n    }\n}\n')),(0,l.kt)("p",null,"Top2\u7c7b\u7684",(0,l.kt)("inlineCode",{parentName:"p"},"accumulate(...)"),"\u65b9\u6cd5\u63a5\u53d7\u4e24\u4e2a\u8f93\u5165\u3002\u7b2c\u4e00\u4e2a\u662f\u7d2f\u52a0\u5668\uff0c\u7b2c\u4e8c\u4e2a\u662f\u7528\u6237\u5b9a\u4e49\u7684\u8f93\u5165\u3002\n\u4e3a\u4e86\u8ba1\u7b97\u7ed3\u679c\uff0c\u7d2f\u52a0\u5668\u9700\u8981\u5b58\u50a8\u5df2\u7d2f\u79ef\u7684\u6240\u6709\u6570\u636e\u76842\u4e2a\u6700\u9ad8\u503c\u3002\u7d2f\u52a0\u5668\u7531Flink\u7684checkpoint\u673a\u5236\u81ea\u52a8\u7ba1\u7406\uff0c\u5e76\u5728\u51fa\u73b0\u9519\u8bef\u65f6\u6062\u590d\uff0c\u4ee5\u786e\u4fdd\u7cbe\u786e\u4e00\u6b21\u7684\u8bed\u4e49\u3002\u7ed3\u679c\u503c\u4e0e\u6392\u540d\u7d22\u5f15\u4f5c\u4e3a\u7ed3\u679c\u4e00\u8d77\u53d1\u51fa\u3002"),(0,l.kt)("h3",{id:"\u5fc5\u9009\u548c\u53ef\u9009\u65b9\u6cd5-1"},"\u5fc5\u9009\u548c\u53ef\u9009\u65b9\u6cd5"),(0,l.kt)("p",null,"\u5bf9\u4e8e\u6bcf\u4e2a\u81ea\u5b9a\u4e49",(0,l.kt)("inlineCode",{parentName:"p"},"TableAggregateFunction"),"\uff0c\u4ee5\u4e0b\u65b9\u6cd5\u662f\u5fc5\u987b\u7684\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"createAccumulator()"),(0,l.kt)("li",{parentName:"ul"},"accumulate(...)"),(0,l.kt)("li",{parentName:"ul"},"emitValue(...) or emitUpdateWithRetract(...)")),(0,l.kt)("p",null,"\u6b64\u5916\uff0c\u8fd8\u6709\u4e00\u4e9b\u53ef\u9009\u7684\u65b9\u6cd5\u53ef\u4ee5\u5b9e\u73b0\u3002\u5176\u4e2d\u4e00\u4e9b\u65b9\u6cd5\u53ef\u4ee5\u8ba9\u7cfb\u7edf\u66f4\u6709\u6548\u5730\u6267\u884c\u67e5\u8be2\uff0c\u4f46\u5728\u67d0\u4e9b\u60c5\u5883\u4e0b\uff0c\u6709\u4e9b\u65b9\u6cd5\u662f\u5fc5\u9700\u7684\u3002"),(0,l.kt)("p",null,"\u4f8b\u5982\uff0c\u5982\u679c\u5728\u4f1a\u8bdd\u5206\u7ec4\u7a97\u53e3",(0,l.kt)("inlineCode",{parentName:"p"},"\uff08session group window\uff09"),"\u4e0a\u4f7f\u7528\u8868\u805a\u5408\u51fd\u6570\uff0c\u5219",(0,l.kt)("inlineCode",{parentName:"p"},"merge(...)"),"\u65b9\u6cd5\u662f\u5f3a\u5236\u6027\u7684(\u5f53\u9700\u8981\u201c\u8fde\u63a5\u201d\u4e24\u4e2a\u4f1a\u8bdd\u7a97\u53e3\u7684\u6570\u636e\u884c\u65f6\uff0c\u9700\u8981\u8fde\u63a5\u4e24\u4e2a\u4f1a\u8bdd\u7a97\u53e3\u7684\u7d2f\u52a0\u5668)\u3002"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"TableAggregateFunction"),"\u7684\u4ee5\u4e0b\u65b9\u6cd5\u53d6\u51b3\u4e8e\u7528\u4f8b:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"retract(...)\uff1a\u5728OVER\u7a97\u53e3\u4e0a\u8fdb\u884c\u805a\u5408\u65f6\u9700\u8981\u4f7f\u7528\u3002"),(0,l.kt)("li",{parentName:"ul"},"merge(...)\uff1a\u5bf9\u4e8e\u8bb8\u591a\u6709\u754c\u805a\u5408\u3001\u65e0\u754c\u4f1a\u8bdd\u3001\u6ed1\u52a8\u7a97\u53e3\u805a\u5408\u90fd\u662f\u5fc5\u9700\u7684\u3002"),(0,l.kt)("li",{parentName:"ul"},"emitValue(...)\uff1a\u5bf9\u4e8e\u6709\u754c\u3001\u7a97\u53e3\u805a\u5408\u662f\u5fc5\u9700\u7684\u3002")),(0,l.kt)("p",null,"TableAggregateFunction\u7684\u4ee5\u4e0b\u65b9\u6cd5\u53ef\u4ee5\u63d0\u9ad8\u6d41\u4f5c\u4e1a\u7684\u6027\u80fd\uff1a"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"emitUpdateWithRetract(...)\uff1a\u7528\u4e8e\u53d1\u51fa\u5728\u56de\u64a4\u6a21\u5f0f\u4e0b\u66f4\u65b0\u7684\u503c\u3002")),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"emitValue(...)"),"\u65b9\u6cd5\u603b\u662f\u901a\u8fc7\u7d2f\u52a0\u5668\u53d1\u51fa\u5b8c\u6574\u7684\u6570\u636e\u3002\u5728\u65e0\u754c\u6d41\u573a\u666f\u4e2d\u53ef\u80fd\u4f1a\u5e26\u6765\u6027\u80fd\u95ee\u9898\u3002\n\u4ee5Top N\u51fd\u6570\u4e3a\u4f8b\uff0c\u6bcf\u6b21",(0,l.kt)("inlineCode",{parentName:"p"},"emitValue(...)"),"\u90fd\u4f1a\u53d1\u51fa\u6240\u6709N\u4e2a\u503c\u3002\u4e3a\u4e86\u63d0\u9ad8\u6027\u80fd\uff0c\u53ef\u4ee5\u5b9e\u73b0",(0,l.kt)("inlineCode",{parentName:"p"},"emitUpdateWithRetract(...)"),"\uff0c\u5728",(0,l.kt)("inlineCode",{parentName:"p"},"retract"),"\u6a21\u5f0f\u4e0b\u589e\u91cf\u8f93\u51fa\u6570\u636e\u3002\n\u6362\u53e5\u8bdd\u8bf4\uff0c\u4e00\u65e6\u6709\u4e86\u66f4\u65b0\uff0c\u8be5\u65b9\u6cd5\u53ef\u4ee5\u5728\u53d1\u9001\u65b0\u7684\u3001\u66f4\u65b0\u7684\u8bb0\u5f55\u4e4b\u524d\u64a4\u9500\u65e7\u8bb0\u5f55\u3002\u8be5\u65b9\u6cd5\u5c06\u4f18\u5148\u4e8e",(0,l.kt)("inlineCode",{parentName:"p"},"emitValue(...)"),"\u65b9\u6cd5\u8c03\u7528\u3002"),(0,l.kt)("p",null,"\u5982\u679c\u8868\u805a\u5408\u51fd\u6570\u53ea\u80fd\u5728OVER\u7a97\u53e3\u4e2d\u5e94\u7528\uff0c\u5219\u53ef\u4ee5\u901a\u8fc7",(0,l.kt)("inlineCode",{parentName:"p"},"getRequirements()"),"\u65b9\u6cd5\u8fd4\u56de",(0,l.kt)("inlineCode",{parentName:"p"},"FunctionRequirement.OVER_WINDOW_ONLY"),"\u6765\u8bf4\u660e\u3002"),(0,l.kt)("p",null,"\u5982\u679c\u4e00\u4e2a\u7d2f\u52a0\u5668\u9700\u8981\u5b58\u50a8\u5927\u91cf\u7684\u6570\u636e\uff0c\u53ef\u4ee5\u4f7f\u7528",(0,l.kt)("inlineCode",{parentName:"p"},"org.apache.flink.table.api.dataview.ListView"),"\u548c",(0,l.kt)("inlineCode",{parentName:"p"},"org.apache.flink.table.api.dataview.MapView"),"\n\u63d0\u4f9b\u7684\u9ad8\u7ea7\u7279\u6027\uff0c\u5728\u65e0\u754c\u6d41\u6570\u636e\u573a\u666f\u4e2d\u5229\u7528Flink\u7684\u72b6\u6001\u540e\u7aef\u3002\u6709\u5173\u8fd9\u4e2a\u9ad8\u7ea7\u7279\u6027\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605\u76f8\u5e94\u7c7b\u7684\u6587\u6863\u3002"),(0,l.kt)("p",null,"\u7531\u4e8e\u6709\u4e9b\u65b9\u6cd5\u662f\u53ef\u9009\u6216\u53ef\u4ee5\u91cd\u8f7d\u7684\uff0c\u56e0\u6b64flink\u4f1a\u6839\u636e\u751f\u6210\u7684\u4ee3\u7801\u6765\u8c03\u7528\u8fd9\u4e9b\u65b9\u6cd5\u3002\u57fa\u7c7b\u5e76\u4e0d\u603b\u662f\u63d0\u4f9b\u6240\u6709\u9700\u8981\u5b9e\u73b0\u7684\u65b9\u6cd5\u7684\u7b7e\u540d\u3002\u7136\u800c\uff0c\u6240\u6709\u63d0\u5230\u7684\u65b9\u6cd5\u90fd\u5fc5\u987b\u662fpublic\uff0c\u975e\u9759\u6001\u7684\uff0c\u5e76\u4e14\u5b8c\u5168\u6309\u7167\u4e0a\u9762\u63d0\u5230\u7684\u540d\u5b57\u547d\u540d\u3002"),(0,l.kt)("p",null,"\u4e0b\u9762\u7ed9\u51fa\u4e86\u672a\u5728TableAggregateFunction\u4e2d\u58f0\u660e\u5e76\u7531\u751f\u6210\u7684\u4ee3\u7801\u8c03\u7528\u7684\u6240\u6709\u65b9\u6cd5\u7684\u8be6\u7ec6\u6587\u6863\u3002"),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"accumulate(...)\uff1a")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * \u5904\u7406\u8f93\u5165\u53c2\u6570\u503c\uff0c\u5e76\u4e14\u66f4\u65b0\u63d0\u4f9b\u7684\u7d2f\u52a0\u5668\u5b9e\u4f8b\u3002\n * \u8fd9\u4e2a\u65b9\u6cd5\u53ef\u4ee5\u88ab\u91cd\u8f7d\u3002\n * \u81ea\u5b9a\u4e49\u805a\u5408\u51fd\u6570\u5fc5\u987b\u6709\u81f3\u5c11\u4e00\u4e2aaccumulate()\u65b9\u6cd5\u3002\n *\n * @param acc \u5305\u542b\u5f53\u524d\u805a\u5408\u7ed3\u679c\u7684\u7d2f\u52a0\u5668\n * @param: [user defined inputs] \u8f93\u5165\u503c\uff08\u901a\u5e38\u662f\u65b0\u5230\u8fbe\u6570\u636e\u884c\u5b57\u6bb5\uff09\n **/\npublic void accumulate(ACC accumulator,[user defined inputs])\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"retract(...)\uff1a")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * \u4ece\u7d2f\u52a0\u5668\u5b9e\u4f8b\u64a4\u56de\u8f93\u5165\u503c\u3002\n * \u5f53\u524d\u8bbe\u8ba1\u5047\u5b9a\u8be5\u8f93\u5165\u503c\u662f\u4ee5\u524d\u7d2f\u52a0\u8fc7\u7684\u503c\u3002\n * \u8be5\u65b9\u6cd5\u53ef\u4ee5\u88ab\u91cd\u8f7d\u3002\n * \u5728\u65e0\u754c\u8868\u4e0a\u4f7f\u7528\u6709\u754cOVER\u805a\u5408\u6570\u636e\u65f6\uff0c\u5fc5\u987b\u5b9e\u73b0\u8be5\u65b9\u6cd5\u3002\n * @param accumulator \u5305\u542b\u5f53\u524d\u805a\u5408\u7ed3\u679c\u7684\u7d2f\u52a0\u5668\n * @param [user defined inputs] \u8f93\u5165\u503c\uff08\u901a\u5e38\u662f\u65b0\u5230\u8fbe\u6570\u636e\u884c\u5b57\u6bb5\uff09\n */\npublic void retract(ACC accumulator,[user defined inputs])\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"merge(...)\uff1a")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * \u5c06\u4e00\u7ec4\u7d2f\u52a0\u5668\u5b9e\u4f8b\u805a\u5408\u5230\u4e00\u4e2a\u7d2f\u52a0\u5668\u5b9e\u4f8b\u3002\n * \u5728\u65e0\u754c\u4f1a\u8bdd\u7a97\u53e3\u3001\u6ed1\u52a8\u7a97\u53e3\u8fdb\u884c\u5206\u7ec4\u805a\u5408\uff0c\u4ee5\u53ca\u5728\u6709\u754c\u5206\u533a\u805a\u5408\u65f6\u5fc5\u987b\u5b9e\u73b0\u8be5\u65b9\u6cd5\u3002\n * \u9664\u6b64\u4e4b\u5916\uff0c\u5b9e\u73b0\u8be5\u65b9\u6cd5\u5bf9\u4f18\u5316\u5668\u662f\u6709\u5e2e\u52a9\u7684\u3002\n * \u6bd4\u5982\uff0c\u4e24\u9636\u6bb5\u805a\u5408\u4f18\u5316\u8981\u6c42\u6240\u6709\u805a\u5408\u51fd\u6570\u652f\u6301\u201cmerge\u201d\u65b9\u6cd5\n *\n * @param accumulator \u4fdd\u5b58\u805a\u5408\u7ed3\u679c\u7684\u7d2f\u52a0\u5668\u3002\u6ce8\u610f\uff0c\u5b83\u5e94\u8be5\u5305\u542b\u4e4b\u524d\u805a\u5408\u7684\u7ed3\u679c\uff0c\u56e0\u6b64\uff0c\u6211\u4eec\u4e0d\u80fd\u5728\u805a\u5408\u65b9\u6cd5\u4e2d\u66ff\u6362\u6216\u6e05\u7406\u8fd9\u4e2a\u5b9e\u4f8b\u3002\n * @param iterable \u4e00\u7ec4\u5c06\u88ab\u5408\u5e76\u7684\u7d2f\u52a0\u5668\u5bf9\u5e94\u7684\u8fed\u4ee3\u5668\n */\npublic void merge(ACC accumulator,java.lang.Iterable<ACC> iterable)\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"emitValue(...)\uff1a")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"/**\n * \u6bcf\u6b21\u805a\u5408\u7ed3\u679c\u5e94\u8be5\u88ab\u7269\u5316\u65f6\u8c03\u7528\u3002\u8fd4\u56de\u503c\u53ef\u4ee5\u662f\u65e9\u671f\u672a\u5b8c\u6210\u7684\u7ed3\u679c\uff08\u5f53\u6570\u636e\u5230\u8fbe\u65f6\u5b9a\u671f\u53d1\u51fa\uff09\uff0c\u6216\u8005\u662f\u6700\u7ec8\u7684\u805a\u5408\u7ed3\u679c\u3002\n *\n * param: accumulator \u5305\u542b\u5f53\u524d\u805a\u5408\u7ed3\u679c\u7684\u7d2f\u52a0\u5668\u3002\n * param: out \u8f93\u51fa\u6570\u636e\u7684\u6536\u96c6\u5668\u3002\n */\npublic void emitValue(ACC accumulator,org.apache.flink.util.Collector<T> out)\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"emitUpdateWithRetract(...)\uff1a")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},'/*\n * \u6bcf\u6b21\u805a\u5408\u7ed3\u679c\u5e94\u8be5\u88ab\u7269\u5316\u65f6\u8c03\u7528\u3002\u8fd4\u56de\u503c\u53ef\u4ee5\u662f\u65e9\u671f\u672a\u5b8c\u6210\u7684\u7ed3\u679c\uff08\u5f53\u6570\u636e\u5230\u8fbe\u65f6\u5b9a\u671f\u53d1\u51fa\uff09\uff0c\u6216\u8005\u662f\u6700\u7ec8\u7684\u805a\u5408\u7ed3\u679c\u3002\n * \u4e0eemitValue()\u76f8\u6bd4\uff0cemitUpdateWithRetract() \u7528\u6765\u53d1\u51fa\u88ab\u66f4\u65b0\u7684\u7ed3\u679c\u503c\u3002\n * \u8fd9\u4e2a\u65b9\u6cd5\u5728\u56de\u64a4\u6a21\u5f0f\uff08\u4e5f\u53eb\u505a"update before" \u548c "update after"\uff09\u4e0b\u4f1a\u7acb\u5373\u8f93\u51fa\u6570\u636e\u3002\n * \u4e00\u65e6\u9047\u5230\u4e00\u4e2a\u66f4\u65b0\uff0c\u6211\u4eec\u5fc5\u987b\u5728\u53d1\u9001\u65b0\u7684\u66f4\u65b0\u6570\u636e\u4e4b\u524d\u64a4\u56de\u65e7\u7684\u8bb0\u5f55\u3002\n * \u5982\u679c\u5728\u8868\u805a\u5408\u51fd\u6570\u4e2d\u540c\u65f6\u5b9e\u73b0\u4e86emitUpdateWithRetract()\u548cemitValue()\uff0c\u5219\u4f1a\u4f18\u5148\u4f7f\u7528emitUpdateWithRetract()\uff0c\n * \u56e0\u4e3a\u8fd9\u4e2a\u65b9\u6cd5\u53ef\u4ee5\u4ee5\u589e\u957f\u7684\u65b9\u5f0f\u8f93\u51fa\u6570\u636e\uff0c\u6bd4emitValue\u66f4\u6709\u6548\u3002\n *\n * param: accumulator \u5305\u542b\u5f53\u524d\u805a\u5408\u7ed3\u679c\u7684\u7d2f\u52a0\u5668\u3002\n * param: out \u56de\u64a4\u6536\u96c6\u5668\u88ab\u7528\u4e8e\u8f93\u51fa\u6570\u636e\u3002\u4f7f\u7528collect()\u65b9\u6cd5\u8f93\u51fa\u589e\u52a0\u7684\u6570\u636e\uff0c\u4f7f\u7528retract()\u65b9\u6cd5\u5220\u9664\u6570\u636e\u3002\n */\npublic void emitUpdateWithRetract(ACC accumulator,RetractableCollector<T> out)\n')),(0,l.kt)("h3",{id:"retraction\u6848\u4f8b"},"Retraction\u6848\u4f8b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-java"},"\nimport org.apache.flink.api.java.tuple.Tuple2;\nimport org.apache.flink.table.functions.TableAggregateFunction;\n\n// \u524d\u4e24\u4e2a\u5c5e\u6027\u8868\u793a\u6700\u65b0\u7684top2\uff0c\u540e\u4e24\u4e2a\u5c5e\u6027\u8868\u793a\u4e0a\u4e00\u6b21top2\npublic class Top2WithRetractAccumulator {\n    public Integer first;\n    public Integer second;\n    public Integer oldFirst;\n    public Integer oldSecond;\n}\n\npublic class Top2WithRetract extends TableAggregateFunction<Tuple2<Integer, Integer>, Top2WithRetractAccumulator> {\n    @Override\n    public Top2WithRetractAccumulator createAccumulator() {\n        Top2WithRetractAccumulator acc = new Top2WithRetractAccumulator();\n        acc.first = Integer.MIN_VALUE;\n        acc.second = Integer.MIN_VALUE;\n        acc.oldFirst = Integer.MIN_VALUE;\n        acc.oldSecond = Integer.MIN_VALUE;\n        return acc;\n    }\n\n    public void accumulate(Top2WithRetractAccumulator acc, Integer v) {\n        // \u66f4\u65b0\u6700\u65b0top2\u6570\u636e\n        if (v > acc.first) {\n            acc.second = acc.first;\n            acc.first = v;\n        } else if (v > acc.second) {\n            acc.second = v;\n        }\n    }\n\n    public void emitUpdateWithRetract(Top2WithRetractAccumulator acc, RetractableCollector<Tuple2<Integer, Integer>> out) {\n        if (!acc.first.equals(acc.oldFirst)) {\n            // \u5982\u679c\u53d1\u73b0\u6709\u66f4\u65b0\u6570\u636e\uff0c\u5219\u5148\u5220\u9664\u4e4b\u524d\u7684\u65e7\u503c\uff0c\u7136\u540e\u53d1\u51fa\u65b0\u503c\n            if (acc.oldFirst != Integer.MIN_VALUE) {\n                out.retract(Tuple2.of(acc.oldFirst, 1));\n            }\n            out.collect(Tuple2.of(acc.first, 1));\n            acc.oldFirst = acc.first;\n        }\n        if (!acc.second.equals(acc.oldSecond)) {\n            // \u5982\u679c\u53d1\u73b0\u6709\u66f4\u65b0\u6570\u636e\uff0c\u5219\u5148\u5220\u9664\u4e4b\u524d\u7684\u65e7\u503c\uff0c\u7136\u540e\u53d1\u51fa\u65b0\u503c\n            if (acc.oldSecond != Integer.MIN_VALUE) {\n                out.retract(Tuple2.of(acc.oldSecond, 2));\n            }\n            out.collect(Tuple2.of(acc.second, 2));\n            acc.oldSecond = acc.second;\n        }\n    }\n")))}s.isMDXComponent=!0},9930:(n,e,t)=>{t.d(e,{Z:()=>a});const a=t.p+"assets/images/aggregate-function-3935a933c2c2c5f9f8b720595b0eb5ff.png"},8148:(n,e,t)=>{t.d(e,{Z:()=>a});const a=t.p+"assets/images/table-aggregate-function-4477e8c5be7d6733073ad9610e2ad4f6.png"}}]);